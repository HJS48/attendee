<!DOCTYPE html>
<html>
<head>
    <title>Meeting Recorder - Health Dashboard</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            color: #333;
        }
        h1 { margin-bottom: 20px; font-size: 24px; }
        h2 { font-size: 16px; margin-bottom: 12px; color: #666; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .refresh-btn {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .refresh-btn:hover { background: #0056b3; }
        .last-updated { color: #888; font-size: 13px; }

        /* Coverage Pipeline */
        .coverage-pipeline {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .pipeline-step {
            flex: 1;
            text-align: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        .pipeline-step .value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .pipeline-step .label {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }
        .pipeline-step.highlight {
            background: #d4edda;
        }
        .pipeline-step.highlight .value { color: #28a745; }
        .pipeline-arrow {
            color: #ccc;
            font-size: 18px;
            flex-shrink: 0;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 16px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .card-header h2 { margin: 0; }
        .card-header input[type="date"] {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th { font-weight: 600; color: #666; background: #fafafa; }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-error { background: #f8d7da; color: #721c24; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        .badge-secondary { background: #e2e3e5; color: #383d41; }

        .pipeline-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            padding: 12px 0;
        }
        .pipeline-col {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px 16px;
        }
        .pipeline-col h3 {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }
        .metric-label {
            font-size: 13px;
            color: #555;
        }
        .metric-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        .metric-error {
            color: #dc3545;
        }
        #bot-health-breakdown .metric-row {
            font-size: 12px;
        }
        #bot-health-breakdown .badge {
            margin-right: 4px;
        }

        .two-col {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 16px;
        }

        .loading { color: #888; font-style: italic; }

        .url-cell {
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .events-table-container {
            max-height: 500px;
            overflow-y: auto;
        }

        .count-badge {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 8px;
        }

        /* Calendar Sync Health */
        .row-error { background: #fff5f5; }
        .error-text { color: #dc3545; font-size: 12px; max-width: 300px; }

        /* Infrastructure Status */
        .status-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .status-green { background: #28a745; }
        .status-yellow { background: #ffc107; }
        .status-red { background: #dc3545; }
        .sublabel { font-size: 11px; color: #888; margin-top: 2px; }

        /* Live Logs */
        .log-controls { display: flex; gap: 8px; align-items: center; }
        .log-select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        .log-container {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            padding: 12px;
            border-radius: 4px;
            height: 400px;
            overflow-y: auto;
        }
        .log-line { padding: 2px 0; white-space: nowrap; }
        .log-line:hover { background: #2d2d2d; }
        .log-time { color: #888; margin-right: 8px; }
        .log-msg { color: #d4d4d4; }
        .log-error .log-msg { color: #f48771; }
        .log-warning .log-msg { color: #dcdcaa; }
        .log-footer {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 12px;
            color: #888;
        }

        /* Kubernetes Monitoring */
        .k8s-section { display: none; }
        .k8s-section.visible { display: block; }
        .docker-section { display: block; }
        .docker-section.hidden { display: none; }

        .alert-banner {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .alert-banner.critical {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #dc2626;
        }
        .alert-banner.warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #d97706;
        }
        .alert-banner.healthy {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #059669;
        }
        .alert-icon { font-size: 20px; }
        .alert-count { font-weight: 600; }
        .alert-detail { font-size: 13px; opacity: 0.9; }

        .k8s-stats-row {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        .k8s-stat {
            background: white;
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-align: center;
        }
        .k8s-stat .value { font-size: 24px; font-weight: bold; color: #333; }
        .k8s-stat .label { font-size: 11px; color: #666; margin-top: 4px; }
        .k8s-stat.healthy .value { color: #10b981; }
        .k8s-stat.warning .value { color: #f59e0b; }
        .k8s-stat.error .value { color: #ef4444; }

        .resource-bar-container {
            margin-bottom: 12px;
        }
        .resource-bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        .resource-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        .resource-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .resource-bar-fill.low { background: #10b981; }
        .resource-bar-fill.medium { background: #f59e0b; }
        .resource-bar-fill.high { background: #ef4444; }

        .issues-table { margin-top: 12px; }
        .issues-table td, .issues-table th { padding: 8px 12px; font-size: 13px; }
        .issue-reason {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
        }
        .issue-crashloop { background: #fee2e2; color: #dc2626; }
        .issue-imagepull { background: #fef3c7; color: #d97706; }
        .issue-oom { background: #e0e7ff; color: #4f46e5; }
        .issue-pending { background: #dbeafe; color: #2563eb; }

        .lookup-form {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 16px;
        }
        .lookup-form input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            width: 250px;
        }
        .lookup-form button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .lookup-form button:hover { background: #0056b3; }

        .lookup-result {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
        }
        .lookup-result h4 { margin-bottom: 12px; font-size: 14px; color: #333; }
        .lookup-result .detail-row {
            display: flex;
            padding: 4px 0;
            font-size: 13px;
        }
        .lookup-result .detail-label {
            width: 140px;
            color: #666;
            flex-shrink: 0;
        }
        .lookup-result .detail-value {
            color: #333;
            word-break: break-all;
        }
        .lookup-result .events-list {
            margin-top: 8px;
            max-height: 150px;
            overflow-y: auto;
        }
        .lookup-result .event-item {
            padding: 4px 0;
            font-size: 12px;
            border-bottom: 1px solid #eee;
        }

        /* Resource Usage Section */
        .resource-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .resource-controls select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        .bot-resource-table tbody tr {
            cursor: pointer;
            transition: background 0.15s ease;
        }
        .bot-resource-table tbody tr:hover {
            background: #f0f7ff;
        }
        .resource-bar-inline {
            display: inline-block;
            width: 80px;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            vertical-align: middle;
            margin-right: 8px;
        }
        .resource-bar-inline .fill {
            height: 100%;
            border-radius: 4px;
        }
        .resource-bar-inline .fill.low { background: #10b981; }
        .resource-bar-inline .fill.medium { background: #f59e0b; }
        .resource-bar-inline .fill.high { background: #ef4444; }

        /* Bot Detail Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: translateY(20px);
            transition: transform 0.2s ease;
        }
        .modal-overlay.visible .modal-content {
            transform: translateY(0);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #eee;
        }
        .modal-header h3 {
            font-size: 16px;
            color: #333;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 0;
            line-height: 1;
        }
        .modal-close:hover { color: #333; }
        .modal-body {
            padding: 20px;
        }
        .chart-container {
            position: relative;
            height: 250px;
            margin-bottom: 20px;
        }
        .bot-info-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        .bot-info-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }
        .bot-info-item .value {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        .bot-info-item .label {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }
        .bot-info-item.warning .value { color: #f59e0b; }
        .bot-info-item.error .value { color: #ef4444; }

        /* System Health Bar */
        .system-health-bar {
            background: white;
            border-radius: 8px;
            padding: 12px 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 24px;
            flex-wrap: wrap;
        }
        .health-item { display: flex; align-items: center; gap: 8px; }
        .health-item .label { font-size: 13px; color: #666; }
        .health-item .status-dot { width: 10px; height: 10px; }
        .issues-badge { background: #ef4444; color: white; padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .issues-badge.none { background: #10b981; }

        /* Active Issues Panel */
        .active-issues-panel {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .active-issues-panel.hidden { display: none; }
        .active-issues-panel h2 { color: #dc2626; font-size: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .issue-group { margin-bottom: 12px; }
        .issue-group:last-child { margin-bottom: 0; }
        .issue-group h3 { font-size: 14px; color: #991b1b; margin-bottom: 8px; }
        .issue-items { display: flex; flex-wrap: wrap; gap: 8px; }
        .issue-item { background: white; border: 1px solid #fecaca; border-radius: 6px; padding: 8px 12px; font-size: 13px; }
        .issue-item .count { font-weight: 600; color: #dc2626; }

        /* Two Column Layout */
        .two-column-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
        @media (max-width: 1200px) { .two-column-grid { grid-template-columns: 1fr; } }

        /* Collapsible Sections */
        .collapsible-header { cursor: pointer; user-select: none; }
        .collapsible-header::before { content: '\25BC'; margin-right: 8px; font-size: 10px; display: inline-block; transition: transform 0.2s; }
        .collapsible-header.collapsed::before { transform: rotate(-90deg); }
        .collapsible-content.collapsed { display: none; }

        /* Processing Pipeline Card */
        .processing-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        .processing-col {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
        }
        .processing-col h4 {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .processing-metric {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 13px;
        }
        .processing-metric .value { font-weight: 600; }
        .processing-metric .value.error { color: #dc3545; }
        .processing-metric .value.warning { color: #f59e0b; }

        /* External Integrations Card */
        .integrations-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        .integration-col {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
        }
        .integration-col h4 {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
        }
        @media (max-width: 900px) {
            .integrations-grid { grid-template-columns: repeat(2, 1fr); }
        }

        /* Celery section enhanced */
        .celery-enhanced {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
        }
        .celery-stat {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }
        .celery-stat h4 {
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
            font-weight: 600;
        }
        .celery-stat .value {
            font-size: 20px;
            font-weight: bold;
        }
        .celery-stat .sublabel {
            font-size: 10px;
            color: #888;
            margin-top: 2px;
        }
    </style>
    <!-- Chart.js for resource graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Meeting Recorder Health Dashboard</h1>
            <div class="header-right">
                <span class="last-updated" id="last-updated">Loading...</span>
                <button class="refresh-btn" onclick="loadData()">Refresh</button>
            </div>
        </div>

        <!-- System Health Bar -->
        <div class="system-health-bar" id="system-health-bar">
            <div class="health-item">
                <span class="label">Scheduler</span>
                <span class="status-dot" id="health-scheduler"></span>
            </div>
            <div class="health-item">
                <span class="label">Worker</span>
                <span class="status-dot" id="health-worker"></span>
            </div>
            <div class="health-item">
                <span class="label">Database</span>
                <span class="status-dot" id="health-database"></span>
            </div>
            <div class="health-item">
                <span class="label">Redis</span>
                <span class="status-dot" id="health-redis"></span>
            </div>
            <div class="health-item k8s-only" style="display: none;">
                <span class="label">K8s API</span>
                <span class="status-dot" id="health-k8s-api"></span>
            </div>
            <div class="health-item k8s-only" style="display: none;">
                <span class="label">Nodes</span>
                <span id="health-nodes">--</span>
            </div>
            <div class="health-item" style="margin-left: auto;">
                <span class="issues-badge none" id="issues-badge">0 Issues</span>
            </div>
        </div>

        <!-- Active Issues Panel -->
        <div class="active-issues-panel hidden" id="active-issues-panel">
            <h2><span>!</span> Active Issues</h2>
            <div id="issues-content">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- Section 1: Coverage Pipeline -->
        <div class="coverage-pipeline">
            <div class="pipeline-step">
                <div class="value" id="total-events">--</div>
                <div class="label">Total Events</div>
            </div>
            <span class="pipeline-arrow">→</span>
            <div class="pipeline-step">
                <div class="value" id="events-with-url">--</div>
                <div class="label">With URL</div>
            </div>
            <span class="pipeline-arrow">→</span>
            <div class="pipeline-step">
                <div class="value" id="unique-events">--</div>
                <div class="label">Unique</div>
            </div>
            <span class="pipeline-arrow">→</span>
            <div class="pipeline-step">
                <div class="value" id="active-bots">--</div>
                <div class="label">Bots</div>
            </div>
            <span class="pipeline-arrow">→</span>
            <div class="pipeline-step highlight">
                <div class="value" id="coverage-rate">--</div>
                <div class="label">Coverage</div>
            </div>
        </div>

        <!-- Section 2: Bot States (All-Time) - Collapsible -->
        <div class="card">
            <div class="card-header collapsible-header collapsed" onclick="toggleCollapsible('bot-states')">
                <h2>Bot States (Active)</h2>
                <span style="color:#888;font-size:13px;">Total bots in DB: <span id="total-bots">--</span></span>
            </div>
            <div id="bot-states" class="collapsible-content collapsed">
                <table id="states-table">
                    <thead>
                        <tr>
                            <th>State</th>
                            <th>Count</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody id="states-body">
                        <tr><td colspan="3" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Section 3: Pipeline Status (Per Date) -->
        <div class="card">
            <div class="card-header">
                <h2>Pipeline Status</h2>
                <input type="date" id="date-picker" onchange="loadDateData()">
            </div>
            <div class="pipeline-grid">
                <div class="pipeline-col">
                    <h3>Pipeline</h3>
                    <div class="metric-row">
                        <span class="metric-label">Events</span>
                        <span class="metric-value" id="pipe-events">--</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Bots Created</span>
                        <span class="metric-value" id="pipe-bots">--</span>
                    </div>
                </div>
                <div class="pipeline-col">
                    <h3>Bot Health</h3>
                    <div id="bot-health-breakdown">
                        <span class="loading">Loading...</span>
                    </div>
                </div>
                <div class="pipeline-col">
                    <h3>Recordings</h3>
                    <div class="metric-row">
                        <span class="metric-label">Complete</span>
                        <span class="metric-value" id="recordings-complete">--</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Failed</span>
                        <span class="metric-value metric-error" id="recordings-failed">--</span>
                    </div>
                </div>
                <div class="pipeline-col">
                    <h3>Transcriptions</h3>
                    <div class="metric-row">
                        <span class="metric-label">Complete</span>
                        <span class="metric-value" id="transcriptions-complete">--</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Failed</span>
                        <span class="metric-value metric-error" id="transcriptions-failed">--</span>
                    </div>
                </div>
                <div class="pipeline-col">
                    <h3>Durations</h3>
                    <div class="metric-row">
                        <span class="metric-label">Avg Meeting</span>
                        <span class="metric-value" id="avg-meeting-duration">--</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Avg Recording</span>
                        <span class="metric-value" id="avg-recording-duration">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 4: Events & Bots List (Per Date) -->
        <div class="card">
            <div class="card-header">
                <h2>Events & Bots <span class="count-badge" id="events-count">0</span></h2>
                <span style="color:#666;font-size:13px;">Unique meetings with URL (deduped)</span>
            </div>
            <div class="events-table-container">
                <table id="events-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Title</th>
                            <th>Meeting URL</th>
                            <th>Calendar Owner</th>
                            <th>Bot ID</th>
                            <th>Bot Status</th>
                            <th>Attendees</th>
                        </tr>
                    </thead>
                    <tbody id="events-body">
                        <tr><td colspan="7" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Recent Failures -->
        <div class="card">
            <div class="card-header">
                <h2>Recent Failures</h2>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <input type="date" id="failure-date-picker" onchange="loadFailures()">
                    <span class="count-badge" id="failure-count">0 failures</span>
                </div>
            </div>

            <!-- Failure breakdown by reason -->
            <div class="pipeline-grid" id="failure-summary" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); margin-bottom: 16px;">
                <span class="loading">Loading...</span>
            </div>

            <table id="failures-table">
                <thead>
                    <tr>
                        <th>Bot ID</th>
                        <th>Event Type</th>
                        <th>Reason</th>
                        <th>Meeting URL</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="failures-body">
                    <tr><td colspan="5" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Calendar Sync Health -->
        <div class="card">
            <div class="card-header">
                <h2>Calendar Sync Health</h2>
                <span class="count-badge" id="calendar-count">0 calendars</span>
            </div>
            <table>
                <thead>
                    <tr><th>Calendar</th><th>Owner</th><th>Status</th><th>Last Sync</th><th>Details</th></tr>
                </thead>
                <tbody id="calendar-sync-body">
                    <tr><td colspan="5" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Resource Usage -->
        <div class="card">
            <div class="card-header">
                <h2>Resource Usage</h2>
                <div class="resource-controls">
                    <select id="resource-time-range" onchange="loadResourceSummary()">
                        <option value="1">Last 1 hour</option>
                        <option value="6">Last 6 hours</option>
                        <option value="24" selected>Last 24 hours</option>
                        <option value="168">Last 7 days</option>
                    </select>
                    <span class="count-badge" id="resource-bot-count">0 bots</span>
                </div>
            </div>
            <div id="resource-no-data" style="display: none; padding: 20px; text-align: center; color: #888;">
                <p>No resource data available. Resource snapshots may be disabled.</p>
                <p style="font-size: 12px; margin-top: 8px;">Enable with: <code>SAVE_BOT_RESOURCE_SNAPSHOTS=true</code></p>
            </div>
            <table class="bot-resource-table" id="resource-table" style="display: none;">
                <thead>
                    <tr>
                        <th>Bot ID</th>
                        <th>Status</th>
                        <th>Peak Memory</th>
                        <th>Peak CPU</th>
                        <th>Memory Limit</th>
                        <th>Duration</th>
                    </tr>
                </thead>
                <tbody id="resource-body">
                    <tr><td colspan="6" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Bot Resource Detail Modal -->
        <div class="modal-overlay" id="bot-resource-modal" onclick="closeBotModal(event)">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3>Bot Resource Details: <code id="modal-bot-id">--</code></h3>
                    <button class="modal-close" onclick="closeBotModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="bot-info-grid" id="modal-info-grid">
                        <div class="bot-info-item">
                            <div class="value" id="modal-peak-mem">--</div>
                            <div class="label">Peak Memory</div>
                        </div>
                        <div class="bot-info-item">
                            <div class="value" id="modal-peak-cpu">--</div>
                            <div class="label">Peak CPU</div>
                        </div>
                        <div class="bot-info-item">
                            <div class="value" id="modal-mem-limit">--</div>
                            <div class="label">Memory Limit</div>
                        </div>
                        <div class="bot-info-item" id="modal-oom-item">
                            <div class="value" id="modal-oom">--</div>
                            <div class="label">OOM Risk</div>
                        </div>
                    </div>
                    <h4 style="font-size: 14px; color: #666; margin-bottom: 12px;">Memory Usage Over Time</h4>
                    <div class="chart-container">
                        <canvas id="memory-chart"></canvas>
                    </div>
                    <h4 style="font-size: 14px; color: #666; margin-bottom: 12px;">CPU Usage Over Time</h4>
                    <div class="chart-container">
                        <canvas id="cpu-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Meeting Sync Pipeline (Full Width) -->
        <div class="card">
            <div class="card-header">
                <h2>Meeting Sync Pipeline</h2>
                <span class="badge badge-info">Today</span>
            </div>
            <div class="processing-grid" style="grid-template-columns: repeat(6, 1fr);">
                <div class="processing-col">
                    <h4>Ended Bots</h4>
                    <div class="processing-metric">
                        <span>Total</span>
                        <span class="value" id="sync-ended-total">--</span>
                    </div>
                    <div class="processing-metric">
                        <span>&nbsp;</span>
                        <span class="value">&nbsp;</span>
                    </div>
                    <div class="processing-metric">
                        <span>&nbsp;</span>
                        <span class="value">&nbsp;</span>
                    </div>
                </div>
                <div class="processing-col">
                    <h4>Recording</h4>
                    <div class="processing-metric">
                        <span>Complete</span>
                        <span class="value" id="sync-rec-complete">--</span>
                    </div>
                    <div class="processing-metric">
                        <span>In Progress</span>
                        <span class="value" id="sync-rec-in-progress">--</span>
                    </div>
                    <div class="processing-metric">
                        <span>Failed</span>
                        <span class="value error" id="sync-rec-failed">--</span>
                    </div>
                </div>
                <div class="processing-col">
                    <h4>Transcription</h4>
                    <div class="processing-metric">
                        <span>Complete</span>
                        <span class="value" id="sync-trans-complete">--</span>
                    </div>
                    <div class="processing-metric">
                        <span>In Progress</span>
                        <span class="value" id="sync-trans-in-progress">--</span>
                    </div>
                    <div class="processing-metric">
                        <span>Failed</span>
                        <span class="value error" id="sync-trans-failed">--</span>
                    </div>
                </div>
                <div class="processing-col">
                    <h4>Supabase Sync</h4>
                    <div class="processing-metric">
                        <span>Complete</span>
                        <span class="value" id="sync-supa-complete">--</span>
                    </div>
                    <div class="processing-metric">
                        <span>Pending</span>
                        <span class="value" id="sync-supa-pending">--</span>
                    </div>
                    <div class="processing-metric">
                        <span>Not Created</span>
                        <span class="value error" id="sync-supa-not-created">--</span>
                    </div>
                </div>
                <div class="processing-col">
                    <h4>Insights</h4>
                    <div class="processing-metric">
                        <span>Success</span>
                        <span class="value" id="sync-insights-success">--</span>
                    </div>
                    <div class="processing-metric">
                        <span>Pending</span>
                        <span class="value" id="sync-insights-pending">--</span>
                    </div>
                    <div class="processing-metric">
                        <span>Failed</span>
                        <span class="value error" id="sync-insights-failed">--</span>
                    </div>
                </div>
                <div class="processing-col">
                    <h4>Emails</h4>
                    <div class="processing-metric">
                        <span>Success</span>
                        <span class="value" id="sync-email-success" style="cursor: pointer; text-decoration: underline;" onclick="toggleEmailDetails()">--</span>
                    </div>
                    <div class="processing-metric">
                        <span>Pending</span>
                        <span class="value" id="sync-email-pending">--</span>
                    </div>
                    <div class="processing-metric">
                        <span>Failed</span>
                        <span class="value error" id="sync-email-failed">--</span>
                    </div>
                </div>
            </div>
            <!-- Email Details (hidden by default) -->
            <div id="email-details" style="display: none; margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                <h4 style="font-size: 12px; color: #666; margin-bottom: 8px; font-weight: 600;">Recent Emails</h4>
                <div id="email-list" style="font-size: 13px; max-height: 200px; overflow-y: auto;"></div>
            </div>
            <!-- Stuck meetings warning -->
            <div id="sync-stuck-warning" style="display: none; margin-top: 12px; padding: 10px 12px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; font-size: 13px;">
                <strong>Warning:</strong> <span id="sync-stuck-count">0</span> meetings have completed transcription but are still pending Supabase sync.
            </div>
        </div>

        <!-- Infrastructure Status -->
        <div class="card">
            <div class="card-header">
                <h2>Infrastructure</h2>
                <span id="infra-mode-badge" class="badge badge-info">--</span>
            </div>

            <!-- Docker Container Status Row (hidden in K8s mode) -->
            <div class="docker-section" id="docker-section">
                <div class="stats-row" id="containers-row" style="margin-bottom: 16px;">
                    <div class="stat-card">
                        <div class="loading">Loading containers...</div>
                    </div>
                </div>
            </div>

            <!-- Kubernetes Section (hidden in Docker mode) -->
            <div class="k8s-section" id="k8s-section">
                <!-- K8s Alerts Banner -->
                <div id="k8s-alerts-banner" class="alert-banner healthy" style="display: none;">
                    <span class="alert-icon">⚠️</span>
                    <span class="alert-count" id="k8s-alert-count">0 alerts</span>
                    <span class="alert-detail" id="k8s-alert-detail"></span>
                </div>

                <!-- K8s Stats Row -->
                <div class="k8s-stats-row">
                    <div class="k8s-stat" id="k8s-api-stat">
                        <div class="value" id="k8s-api-status">--</div>
                        <div class="label">API Health</div>
                    </div>
                    <div class="k8s-stat">
                        <div class="value" id="k8s-pods-running">--</div>
                        <div class="label">Pods Running</div>
                    </div>
                    <div class="k8s-stat">
                        <div class="value" id="k8s-pods-pending">--</div>
                        <div class="label">Pods Pending</div>
                    </div>
                    <div class="k8s-stat">
                        <div class="value" id="k8s-pods-failed">--</div>
                        <div class="label">Pods Failed</div>
                    </div>
                    <div class="k8s-stat">
                        <div class="value" id="k8s-nodes-ready">--</div>
                        <div class="label">Nodes Ready</div>
                    </div>
                    <div class="k8s-stat">
                        <div class="value" id="k8s-api-latency">--</div>
                        <div class="label">API Latency</div>
                    </div>
                </div>

                <!-- Resource Bars -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div class="resource-bar-container">
                        <div class="resource-bar-label">
                            <span>CPU Usage</span>
                            <span id="k8s-cpu-pct">--%</span>
                        </div>
                        <div class="resource-bar">
                            <div class="resource-bar-fill low" id="k8s-cpu-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="resource-bar-container">
                        <div class="resource-bar-label">
                            <span>Memory Usage</span>
                            <span id="k8s-mem-pct">--%</span>
                        </div>
                        <div class="resource-bar">
                            <div class="resource-bar-fill low" id="k8s-mem-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <!-- Pod Issues Table -->
                <div id="k8s-issues-container" style="display: none;">
                    <h3 style="font-size: 14px; color: #666; margin-bottom: 8px;">Pod Issues</h3>
                    <table class="issues-table">
                        <thead>
                            <tr>
                                <th>Pod</th>
                                <th>Namespace</th>
                                <th>Issue</th>
                                <th>Node</th>
                                <th>Age</th>
                            </tr>
                        </thead>
                        <tbody id="k8s-issues-body"></tbody>
                    </table>
                </div>

                <!-- Deployments Status -->
                <div id="k8s-deployments-container" style="margin-top: 16px;">
                    <h3 style="font-size: 14px; color: #666; margin-bottom: 8px;">Deployments</h3>
                    <div id="k8s-deployments-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- K8s Events (Warnings) -->
                <div id="k8s-events-container" style="margin-top: 16px; display: none;">
                    <h3 style="font-size: 14px; color: #666; margin-bottom: 8px;">
                        Recent Events
                        <span id="k8s-events-warning-count" style="color: #f59e0b; font-size: 12px;"></span>
                    </h3>
                    <div id="k8s-events-list" style="max-height: 200px; overflow-y: auto; font-size: 12px;">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Hetzner Cloud Section -->
                <div id="hetzner-section" style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                    <h3 style="font-size: 14px; color: #666; margin-bottom: 12px;">Hetzner Cloud</h3>

                    <!-- Hetzner Stats Row -->
                    <div class="k8s-stats-row" style="grid-template-columns: repeat(5, 1fr);">
                        <div class="k8s-stat" id="hetzner-ccm-stat">
                            <div class="value" id="hetzner-ccm-status">--</div>
                            <div class="label">CCM</div>
                        </div>
                        <div class="k8s-stat" id="hetzner-autoscaler-stat">
                            <div class="value" id="hetzner-autoscaler-status">--</div>
                            <div class="label">Autoscaler</div>
                        </div>
                        <div class="k8s-stat">
                            <div class="value" id="hetzner-bot-nodes">--</div>
                            <div class="label">Bot Nodes</div>
                        </div>
                        <div class="k8s-stat">
                            <div class="value" id="hetzner-bot-capacity">--</div>
                            <div class="label">Bot Capacity</div>
                        </div>
                        <div class="k8s-stat">
                            <div class="value" id="hetzner-cost-hourly">--</div>
                            <div class="label">EUR/hr</div>
                        </div>
                    </div>

                    <!-- Node Pool Breakdown -->
                    <div id="hetzner-pools-container" style="margin-top: 12px;">
                        <h4 style="font-size: 13px; color: #666; margin-bottom: 8px;">Node Pools</h4>
                        <div id="hetzner-pools-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Autoscaler Events -->
                    <div id="hetzner-events-container" style="margin-top: 12px; display: none;">
                        <h4 style="font-size: 13px; color: #666; margin-bottom: 8px;">
                            Recent Scale Events
                            <span id="hetzner-events-count" style="color: #888; font-size: 11px;"></span>
                        </h4>
                        <div id="hetzner-events-list" style="max-height: 150px; overflow-y: auto; font-size: 12px;">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Celery Queue (shown in both modes) - Enhanced -->
            <div class="celery-enhanced">
                <div class="celery-stat">
                    <h4>Worker Pod</h4>
                    <div class="value"><span class="status-dot" id="celery-worker-status"></span></div>
                    <div class="sublabel" id="celery-worker-label">Checking...</div>
                </div>
                <div class="celery-stat">
                    <h4>Redis</h4>
                    <div class="value"><span class="status-dot" id="celery-redis-status"></span></div>
                    <div class="sublabel" id="celery-redis-label">Checking...</div>
                </div>
                <div class="celery-stat">
                    <h4>Workers</h4>
                    <div class="value" id="celery-workers">--</div>
                    <div class="sublabel">active workers</div>
                </div>
                <div class="celery-stat">
                    <h4>Active Tasks</h4>
                    <div class="value" id="celery-active">--</div>
                    <div class="sublabel">processing now</div>
                </div>
                <div class="celery-stat">
                    <h4>Pending</h4>
                    <div class="value" id="celery-pending">--</div>
                    <div class="sublabel">in queue</div>
                </div>
            </div>
        </div>

        <!-- Kubernetes Bot/Pod Lookup (only shown in K8s mode) -->
        <div class="card k8s-section" id="k8s-lookup-section">
            <div class="card-header">
                <h2>Bot/Pod Lookup</h2>
            </div>
            <div class="lookup-form">
                <input type="text" id="k8s-lookup-input" placeholder="Enter bot_id or pod_name">
                <button onclick="doK8sLookup()">Search</button>
            </div>
            <div id="k8s-lookup-result" style="display: none;"></div>
        </div>

        <!-- Live Logs Stream - Collapsible -->
        <div class="card">
            <div class="card-header collapsible-header collapsed" onclick="toggleCollapsible('live-logs')">
                <h2>Live Logs</h2>
                <div class="log-controls" onclick="event.stopPropagation()">
                    <select id="log-source" class="log-select">
                        <option value="worker">worker</option>
                        <option value="scheduler">scheduler</option>
                        <option value="app">app</option>
                    </select>
                    <select id="log-level" class="log-select">
                        <option value="INFO">INFO+</option>
                        <option value="WARNING">WARNING+</option>
                        <option value="ERROR">ERROR only</option>
                    </select>
                    <button class="refresh-btn" id="log-pause">Pause</button>
                    <button class="refresh-btn" id="log-clear" style="background:#6c757d;">Clear</button>
                </div>
            </div>

            <div id="live-logs" class="collapsible-content collapsed">
                <div class="log-container" id="log-container">
                    <div class="log-line log-info">
                        <span class="log-time">--:--:--</span>
                        <span class="badge badge-info">INFO</span>
                        <span class="log-msg">Connecting to log stream...</span>
                    </div>
                </div>

                <div class="log-footer">
                    <span id="log-status">Connecting...</span>
                    <span id="log-count">0 lines</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Set default date to today for both date pickers
        document.getElementById('date-picker').valueAsDate = new Date();
        document.getElementById('failure-date-picker').valueAsDate = new Date();

        async function loadData() {
            await Promise.all([
                loadSystemHealth(),
                loadActiveIssues(),
                loadSummary(),
                loadDateData(),
                loadFailures(),
                loadCalendarSync(),
                loadResourceSummary(),
                loadMeetingSyncStatus(),
                loadInfrastructure()
            ]);
        }

        // Toggle collapsible sections
        function toggleCollapsible(sectionId) {
            const content = document.getElementById(sectionId);
            const header = content.previousElementSibling;
            content.classList.toggle('collapsed');
            header.classList.toggle('collapsed');
        }

        // System Health Bar
        async function loadSystemHealth() {
            try {
                const data = await fetch('/dashboard/api/system-health/').then(r => r.json());

                // Update status dots
                const setStatus = (id, status) => {
                    const dot = document.getElementById(id);
                    if (!dot) return;
                    dot.className = 'status-dot ' + (
                        status === 'healthy' ? 'status-green' :
                        status === 'degraded' ? 'status-yellow' :
                        status === 'error' ? 'status-red' : 'status-yellow'
                    );
                };

                setStatus('health-scheduler', data.scheduler?.status);
                setStatus('health-worker', data.worker?.status);
                setStatus('health-database', data.database?.status);
                setStatus('health-redis', data.redis?.status);

                // K8s-specific items
                if (data.mode === 'kubernetes') {
                    document.querySelectorAll('.k8s-only').forEach(el => el.style.display = 'flex');
                    setStatus('health-k8s-api', data.k8s_api?.status);
                    document.getElementById('health-nodes').textContent = data.k8s_api?.nodes_ready || '--';
                }

                // Issues badge
                const badge = document.getElementById('issues-badge');
                const count = data.issues_count || 0;
                badge.textContent = count === 0 ? 'All Clear' : `${count} Issue${count !== 1 ? 's' : ''}`;
                badge.className = 'issues-badge ' + (count === 0 ? 'none' : '');

            } catch (error) {
                console.error('Failed to load system health:', error);
            }
        }

        // Active Issues Panel
        async function loadActiveIssues() {
            try {
                const data = await fetch('/dashboard/api/active-issues/').then(r => r.json());
                const panel = document.getElementById('active-issues-panel');
                const content = document.getElementById('issues-content');

                if (!data.has_issues) {
                    panel.classList.add('hidden');
                    return;
                }

                panel.classList.remove('hidden');
                let html = '';

                // Stuck bots
                if (data.stuck_bots?.count > 0) {
                    html += '<div class="issue-group"><h3>Stuck Bots</h3><div class="issue-items">';
                    for (const item of data.stuck_bots.by_state) {
                        html += `<div class="issue-item"><span class="count">${item.count}</span> in ${escapeHtml(item.state)} (>${item.threshold_minutes}min, oldest: ${item.oldest_age_minutes}min)</div>`;
                    }
                    html += '</div></div>';
                }

                // Heartbeat timeout bots
                if (data.heartbeat_timeout_bots?.count > 0) {
                    html += `<div class="issue-group"><h3>Heartbeat Timeout</h3><div class="issue-items">`;
                    html += `<div class="issue-item"><span class="count">${data.heartbeat_timeout_bots.count}</span> bots with stale heartbeat (>10min)</div>`;
                    html += '</div></div>';
                }

                // Orphaned recordings
                if (data.orphaned_recordings?.count > 0) {
                    html += `<div class="issue-group"><h3>Orphaned Recordings</h3><div class="issue-items">`;
                    html += `<div class="issue-item"><span class="count">${data.orphaned_recordings.count}</span> recordings in progress with ended bots</div>`;
                    html += '</div></div>';
                }

                // Stalled transcriptions
                if (data.stalled_transcriptions?.count > 0) {
                    html += `<div class="issue-group"><h3>Stalled Transcriptions</h3><div class="issue-items">`;
                    html += `<div class="issue-item"><span class="count">${data.stalled_transcriptions.count}</span> transcriptions stuck >30min</div>`;
                    html += '</div></div>';
                }

                content.innerHTML = html;

            } catch (error) {
                console.error('Failed to load active issues:', error);
            }
        }

        // Processing Pipeline
        async function loadProcessingPipeline() {
            try {
                const data = await fetch('/dashboard/api/processing-pipeline/').then(r => r.json());

                // Recordings
                document.getElementById('proc-rec-in-progress').textContent = data.recordings?.in_progress ?? '--';
                document.getElementById('proc-rec-completed').textContent = data.recordings?.completed_today ?? '--';
                document.getElementById('proc-rec-failed').textContent = data.recordings?.failed_today ?? '--';

                // Transcriptions
                document.getElementById('proc-trans-in-progress').textContent = data.transcriptions?.in_progress ?? '--';
                document.getElementById('proc-trans-pending').textContent = data.transcriptions?.pending_utterances ?? '--';
                document.getElementById('proc-trans-failed').textContent = data.transcriptions?.failed_today ?? '--';

                // DeepGram
                document.getElementById('proc-dg-completed').textContent = data.deepgram?.utterances_completed_today ?? '--';
                document.getElementById('proc-dg-failed').textContent = data.deepgram?.utterances_failed_24h ?? '--';

                // Show failure reasons if there are any
                const failureReasons = data.deepgram?.failure_reasons_24h || {};
                const reasonsDiv = document.getElementById('proc-dg-failure-reasons');
                const reasonEntries = Object.entries(failureReasons);
                if (reasonEntries.length > 0) {
                    reasonsDiv.style.display = 'block';
                    reasonsDiv.querySelector('.value').textContent = reasonEntries
                        .map(([reason, count]) => `${reason}: ${count}`)
                        .join(', ');
                } else {
                    reasonsDiv.style.display = 'none';
                }

                // Transcription Queue
                document.getElementById('proc-async-not-started').textContent = data.async_transcriptions?.not_started ?? '--';
                document.getElementById('proc-async-in-progress').textContent = data.async_transcriptions?.in_progress ?? '--';
                document.getElementById('proc-async-failed').textContent = data.async_transcriptions?.failed_today ?? '--';

            } catch (error) {
                console.error('Failed to load processing pipeline:', error);
            }
        }

        // Pipeline Activity
        let pipelineActivityData = null;

        async function loadPipelineActivity() {
            try {
                const data = await fetch('/dashboard/api/pipeline-activity/').then(r => r.json());
                pipelineActivityData = data;

                // Supabase Syncs
                document.getElementById('pipe-sync-success').textContent = data.supabase_syncs?.success ?? '--';
                document.getElementById('pipe-sync-failed').textContent = data.supabase_syncs?.failed ?? '--';

                // Insight Extraction
                document.getElementById('pipe-insights-success').textContent = data.insight_extraction?.success ?? '--';
                document.getElementById('pipe-insights-failed').textContent = data.insight_extraction?.failed ?? '--';

                // Emails
                document.getElementById('pipe-email-success').textContent = data.emails?.success ?? '--';
                document.getElementById('pipe-email-failed').textContent = data.emails?.failed ?? '--';

                // Update email list
                updateEmailList(data.emails?.recent || []);

            } catch (error) {
                console.error('Failed to load pipeline activity:', error);
            }
        }

        function toggleEmailDetails() {
            const details = document.getElementById('email-details');
            details.style.display = details.style.display === 'none' ? 'block' : 'none';
        }

        function updateEmailList(emails) {
            const list = document.getElementById('email-list');
            if (!emails.length) {
                list.innerHTML = '<div style="color: #666;">No emails sent today</div>';
                return;
            }
            list.innerHTML = emails.map(e => {
                const time = new Date(e.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const status = e.status === 'success'
                    ? '<span style="color: #10b981;">✓</span>'
                    : '<span style="color: #dc3545;">✗</span>';
                const title = e.meeting_title || 'Untitled';
                return `<div style="padding: 4px 0; border-bottom: 1px solid #eee;">
                    ${status} <strong>${e.recipient}</strong>
                    <span style="color: #666; font-size: 11px;"> - ${title} @ ${time}</span>
                    ${e.error ? `<div style="color: #dc3545; font-size: 11px;">${e.error}</div>` : ''}
                </div>`;
            }).join('');
        }

        // Meeting Sync Pipeline (consolidated)
        async function loadMeetingSyncStatus() {
            try {
                // Fetch both APIs in parallel
                const [syncData, pipelineData] = await Promise.all([
                    fetch('/dashboard/api/meeting-sync-status/').then(r => r.json()),
                    fetch('/dashboard/api/pipeline-activity/').then(r => r.json())
                ]);

                // Ended bots
                document.getElementById('sync-ended-total').textContent = syncData.total_ended_bots ?? '--';

                // Recording states
                document.getElementById('sync-rec-complete').textContent = syncData.recording_states?.complete ?? '--';
                document.getElementById('sync-rec-in-progress').textContent = syncData.recording_states?.in_progress ?? '--';
                document.getElementById('sync-rec-failed').textContent = syncData.recording_states?.failed ?? '--';

                // Transcription states
                document.getElementById('sync-trans-complete').textContent = syncData.transcription_states?.complete ?? '--';
                document.getElementById('sync-trans-in-progress').textContent = syncData.transcription_states?.in_progress ?? '--';
                document.getElementById('sync-trans-failed').textContent = syncData.transcription_states?.failed ?? '--';

                // Supabase sync
                if (syncData.supabase_sync?.available) {
                    document.getElementById('sync-supa-complete').textContent = syncData.supabase_sync?.complete ?? '--';
                    document.getElementById('sync-supa-pending').textContent = syncData.supabase_sync?.pending ?? '--';
                    document.getElementById('sync-supa-not-created').textContent = syncData.supabase_sync?.not_created ?? '--';
                } else {
                    document.getElementById('sync-supa-complete').textContent = 'N/A';
                    document.getElementById('sync-supa-pending').textContent = 'N/A';
                    document.getElementById('sync-supa-not-created').textContent = 'N/A';
                }

                // Insights (from pipeline activity - unique meetings by final outcome)
                const insightsSuccess = pipelineData.insight_extraction?.success ?? 0;
                const insightsFailed = pipelineData.insight_extraction?.failed ?? 0;
                const supaComplete = syncData.supabase_sync?.complete ?? 0;
                const insightsPending = Math.max(0, supaComplete - insightsSuccess - insightsFailed);
                document.getElementById('sync-insights-success').textContent = insightsSuccess;
                document.getElementById('sync-insights-pending').textContent = insightsPending;
                document.getElementById('sync-insights-failed').textContent = insightsFailed;

                // Emails (from pipeline activity - unique meetings by final outcome)
                const emailsSuccess = pipelineData.emails?.success ?? 0;
                const emailsFailed = pipelineData.emails?.failed ?? 0;
                const emailsPending = Math.max(0, insightsSuccess - emailsSuccess - emailsFailed);
                document.getElementById('sync-email-success').textContent = emailsSuccess;
                document.getElementById('sync-email-pending').textContent = emailsPending;
                document.getElementById('sync-email-failed').textContent = emailsFailed;

                // Update email list for expandable section
                updateEmailList(pipelineData.emails_detail?.recent || []);

                // Stuck meetings warning
                const stuckCount = syncData.stuck_meetings ?? 0;
                const stuckWarning = document.getElementById('sync-stuck-warning');
                if (stuckCount > 0) {
                    document.getElementById('sync-stuck-count').textContent = stuckCount;
                    stuckWarning.style.display = 'block';
                } else {
                    stuckWarning.style.display = 'none';
                }

            } catch (error) {
                console.error('Failed to load meeting sync status:', error);
            }
        }

        async function loadSummary() {
            try {
                const summary = await fetch('/dashboard/api/summary/').then(r => r.json());

                // Update timestamp
                document.getElementById('last-updated').textContent =
                    `Updated: ${new Date(summary.timestamp).toLocaleTimeString()}`;

                // All-time stats
                document.getElementById('total-events').textContent = summary.all_time.total_events.toLocaleString();
                document.getElementById('events-with-url').textContent = summary.all_time.events_with_url.toLocaleString();
                document.getElementById('unique-events').textContent = summary.all_time.unique_events_deduped.toLocaleString();
                document.getElementById('active-bots').textContent = summary.all_time.active_bots.toLocaleString();
                document.getElementById('total-bots').textContent = summary.all_time.total_bots.toLocaleString();
                document.getElementById('coverage-rate').textContent = `${summary.all_time.coverage_rate}%`;

                // Bot states table
                const statesBody = document.getElementById('states-body');
                const total = summary.all_time.active_bots || 1;
                statesBody.innerHTML = Object.entries(summary.bot_states)
                    .sort((a, b) => b[1] - a[1])
                    .map(([state, count]) => `
                        <tr>
                            <td><span class="badge ${getBadgeClass(state)}">${state}</span></td>
                            <td>${count.toLocaleString()}</td>
                            <td>${(count / total * 100).toFixed(1)}%</td>
                        </tr>
                    `).join('');

            } catch (error) {
                console.error('Failed to load summary:', error);
            }
        }

        async function loadDateData() {
            const date = document.getElementById('date-picker').value;

            try {
                const [pipeline, events] = await Promise.all([
                    fetch(`/dashboard/api/pipeline/?date=${date}`).then(r => r.json()),
                    fetch(`/dashboard/api/events/?date=${date}`).then(r => r.json()),
                ]);

                // Pipeline basics
                document.getElementById('pipe-events').textContent = pipeline.unique_events;
                document.getElementById('pipe-bots').textContent = pipeline.bots_created;

                // Bot health breakdown
                const healthDiv = document.getElementById('bot-health-breakdown');
                const states = Object.entries(pipeline.bot_states || {});
                if (states.length === 0) {
                    healthDiv.innerHTML = '<span style="color:#888;font-size:12px;">No bots</span>';
                } else {
                    healthDiv.innerHTML = states
                        .sort((a, b) => b[1] - a[1])
                        .map(([state, count]) => `
                            <div class="metric-row">
                                <span class="badge ${getBadgeClass(state)}">${state}</span>
                                <span>${count}</span>
                            </div>
                        `).join('');
                }

                // Recordings
                document.getElementById('recordings-complete').textContent = pipeline.recordings?.complete ?? '--';
                document.getElementById('recordings-failed').textContent = pipeline.recordings?.failed ?? '--';

                // Transcriptions
                document.getElementById('transcriptions-complete').textContent = pipeline.transcriptions?.complete ?? '--';
                document.getElementById('transcriptions-failed').textContent = pipeline.transcriptions?.failed ?? '--';

                // Durations
                document.getElementById('avg-meeting-duration').textContent =
                    pipeline.avg_meeting_duration_mins ? `${pipeline.avg_meeting_duration_mins} min` : '--';
                document.getElementById('avg-recording-duration').textContent =
                    pipeline.avg_recording_duration_mins ? `${pipeline.avg_recording_duration_mins} min` : '--';

                // Events list
                document.getElementById('events-count').textContent = events.count;
                const eventsBody = document.getElementById('events-body');

                if (events.events.length === 0) {
                    eventsBody.innerHTML = '<tr><td colspan="7">No events for this date</td></tr>';
                } else {
                    eventsBody.innerHTML = events.events.map(e => `
                        <tr>
                            <td>${e.time}</td>
                            <td>${escapeHtml(e.title)}</td>
                            <td class="url-cell" title="${escapeHtml(e.meeting_url)}">${e.meeting_url}</td>
                            <td>${escapeHtml(e.calendar_owner)}</td>
                            <td>${e.bot_id ? `<code>${e.bot_id.substring(0, 8)}...</code>` : '<span class="badge badge-secondary">None</span>'}</td>
                            <td>${e.bot_status ? `<span class="badge ${getBadgeClass(e.bot_status)}">${e.bot_status}</span>` : '-'}</td>
                            <td>${e.attendees_count}</td>
                        </tr>
                    `).join('');
                }

            } catch (error) {
                console.error('Failed to load date data:', error);
            }
        }

        // Unique colors for all failure reasons - each error type gets a distinct color
        const failureReasonColors = {
            // Join issues (blues/purples)
            'Waiting for Host': { bg: '#dbeafe', border: '#3b82f6', text: '#1d4ed8' },
            'Meeting Not Found': { bg: '#c7d2fe', border: '#6366f1', text: '#4338ca' },
            'Waiting Room Timeout': { bg: '#e0e7ff', border: '#818cf8', text: '#5b21b6' },
            'Join Denied': { bg: '#ede9fe', border: '#a78bfa', text: '#6d28d9' },
            'Connection Failed': { bg: '#f3e8ff', border: '#c084fc', text: '#7e22ce' },
            'Blocked by Captcha': { bg: '#fae8ff', border: '#e879f9', text: '#a21caf' },

            // Auth issues (pinks/magentas)
            'Login Required': { bg: '#fce7f3', border: '#f472b6', text: '#be185d' },
            'Login Failed': { bg: '#ffe4e6', border: '#fb7185', text: '#be123c' },
            'Auth User Not In Meeting': { bg: '#fecdd3', border: '#f43f5e', text: '#9f1239' },

            // Zoom-specific (oranges/ambers)
            'Zoom Auth Failed': { bg: '#ffedd5', border: '#fb923c', text: '#c2410c' },
            'Zoom Status Failed': { bg: '#fef3c7', border: '#fbbf24', text: '#b45309' },
            'Zoom SDK Error': { bg: '#fef9c3', border: '#facc15', text: '#a16207' },
            'Unpublished Zoom App': { bg: '#fefce8', border: '#eab308', text: '#854d0e' },

            // System/Infrastructure (grays/slates)
            'Process Terminated': { bg: '#f1f5f9', border: '#94a3b8', text: '#475569' },
            'Heartbeat Timeout': { bg: '#e2e8f0', border: '#64748b', text: '#334155' },
            'Bot Not Launched': { bg: '#cbd5e1', border: '#475569', text: '#1e293b' },
            'Internal Error': { bg: '#d1d5db', border: '#6b7280', text: '#374151' },
            'UI Element Not Found': { bg: '#e5e7eb', border: '#9ca3af', text: '#4b5563' },
            'RTMP Connection Failed': { bg: '#f3f4f6', border: '#d1d5db', text: '#6b7280' },

            // Recording issues (teals/cyans)
            'Recording Denied': { bg: '#ccfbf1', border: '#2dd4bf', text: '#0f766e' },
            'Recording Request Timeout': { bg: '#cffafe', border: '#22d3ee', text: '#0e7490' },
            'Cannot Grant Permission': { bg: '#a5f3fc', border: '#06b6d4', text: '#0891b2' },

            // User-initiated/Auto leaves (greens)
            'User Requested Leave': { bg: '#d1fae5', border: '#34d399', text: '#047857' },
            'Auto Leave (Silence)': { bg: '#dcfce7', border: '#4ade80', text: '#15803d' },
            'Auto Leave (Alone)': { bg: '#bbf7d0', border: '#22c55e', text: '#166534' },
            'Max Uptime Exceeded': { bg: '#86efac', border: '#16a34a', text: '#14532d' },
            'Closed Captions Failed': { bg: '#a7f3d0', border: '#10b981', text: '#065f46' },

            // Credit/Payment (reds)
            'Out of Credits': { bg: '#fee2e2', border: '#f87171', text: '#b91c1c' },
        };
        const defaultFailureColor = { bg: '#f5f5f5', border: '#a0a0a0', text: '#525252' };

        function getFailureColor(reason) {
            return failureReasonColors[reason] || defaultFailureColor;
        }

        async function loadFailures() {
            try {
                const failureDate = document.getElementById('failure-date-picker').value;
                const url = failureDate
                    ? `/dashboard/api/failures/?date=${failureDate}`
                    : '/dashboard/api/failures/?days=1';
                const data = await fetch(url).then(r => r.json());

                // Update total count
                document.getElementById('failure-count').textContent = `${data.total} failures`;

                // Render summary counts
                const summaryDiv = document.getElementById('failure-summary');
                const summaryEntries = Object.entries(data.summary || {});
                if (summaryEntries.length === 0) {
                    summaryDiv.innerHTML = '<span style="color:#888;font-size:13px;">No failures for this day</span>';
                } else {
                    summaryDiv.innerHTML = summaryEntries
                        .sort((a, b) => b[1] - a[1])
                        .map(([reason, count]) => {
                            const color = getFailureColor(reason);
                            return `
                            <div class="pipeline-col">
                                <h3><span class="badge" style="background:${color.bg}; color:${color.text}; border: 1px solid ${color.border};">${escapeHtml(reason)}</span></h3>
                                <div class="metric-row">
                                    <span class="metric-value">${count}</span>
                                </div>
                            </div>
                        `}).join('');
                }

                // Render table
                const failuresBody = document.getElementById('failures-body');
                if (data.failures.length === 0) {
                    failuresBody.innerHTML = '<tr><td colspan="5">No failures for this day</td></tr>';
                } else {
                    failuresBody.innerHTML = data.failures.map(f => {
                        const color = getFailureColor(f.reason);
                        return `
                        <tr>
                            <td><code>${f.bot_id.substring(0, 8)}...</code></td>
                            <td><span class="badge badge-secondary">${escapeHtml(f.event_type_label)}</span></td>
                            <td><span class="badge" style="background:${color.bg}; color:${color.text}; border: 1px solid ${color.border};">${escapeHtml(f.reason)}</span></td>
                            <td class="url-cell" title="${escapeHtml(f.meeting_url)}">${f.meeting_url || '-'}</td>
                            <td>${new Date(f.timestamp).toLocaleString()}</td>
                        </tr>
                    `}).join('');
                }
            } catch (error) {
                console.error('Failed to load failures:', error);
            }
        }

        function getBadgeClass(state) {
            if (state === 'Ended') return 'badge-success';
            if (state.includes('Error') || state.includes('Fatal')) return 'badge-error';
            if (state === 'Scheduled' || state.includes('Joining')) return 'badge-info';
            return 'badge-warning';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Calendar Sync Health
        async function loadCalendarSync() {
            try {
                const data = await fetch('/dashboard/api/calendar-sync/').then(r => r.json());
                const calendars = data.calendars || [];

                document.getElementById('calendar-count').textContent = `${calendars.length} calendars`;

                const tbody = document.getElementById('calendar-sync-body');
                if (calendars.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5">No calendars configured</td></tr>';
                } else {
                    tbody.innerHTML = calendars.map(cal => {
                        const isError = cal.state === 'disconnected';
                        const rowClass = isError ? 'row-error' : '';

                        // Format last sync time
                        let lastSyncText = 'Never';
                        if (cal.sync_age_minutes !== null) {
                            if (cal.sync_age_minutes < 60) {
                                lastSyncText = `${cal.sync_age_minutes} min ago`;
                            } else if (cal.sync_age_minutes < 1440) {
                                lastSyncText = `${Math.floor(cal.sync_age_minutes / 60)}h ago`;
                            } else {
                                lastSyncText = `${Math.floor(cal.sync_age_minutes / 1440)} days ago`;
                            }
                        }

                        const statusBadge = isError
                            ? '<span class="badge badge-error">Disconnected</span>'
                            : '<span class="badge badge-success">Connected</span>';

                        const details = isError && cal.error
                            ? `<span class="error-text">${escapeHtml(cal.error)}</span>`
                            : '-';

                        return `
                            <tr class="${rowClass}">
                                <td><code>${cal.id}</code></td>
                                <td>${escapeHtml(cal.owner) || '-'}</td>
                                <td>${statusBadge}</td>
                                <td>${lastSyncText}</td>
                                <td>${details}</td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Failed to load calendar sync:', error);
            }
        }

        // Resource Usage
        let memoryChart = null;
        let cpuChart = null;

        async function loadResourceSummary() {
            const hours = document.getElementById('resource-time-range').value;

            try {
                const data = await fetch(`/dashboard/api/resources/summary/?hours=${hours}`).then(r => r.json());

                const table = document.getElementById('resource-table');
                const noData = document.getElementById('resource-no-data');
                const tbody = document.getElementById('resource-body');

                if (!data.bots || data.bots.length === 0) {
                    table.style.display = 'none';
                    noData.style.display = 'block';
                    document.getElementById('resource-bot-count').textContent = '0 bots';
                    return;
                }

                table.style.display = 'table';
                noData.style.display = 'none';
                document.getElementById('resource-bot-count').textContent = `${data.bots.length} bots`;

                // Get limits from top-level
                const memLimit = data.limits?.memory_mb || 3072;
                const cpuLimit = data.limits?.cpu_millicores || 1500;

                tbody.innerHTML = data.bots.map(bot => {
                    const memPct = bot.peak_memory_pct || (memLimit > 0 ? (bot.peak_memory_mb / memLimit) * 100 : 0);
                    const memClass = memPct > 90 ? 'high' : memPct > 70 ? 'medium' : 'low';

                    const cpuPct = bot.peak_cpu_pct || (cpuLimit > 0 ? (bot.peak_cpu_millicores / cpuLimit) * 100 : 0);
                    const cpuClass = cpuPct > 90 ? 'high' : cpuPct > 70 ? 'medium' : 'low';

                    // Use outcome field for status
                    const outcome = bot.outcome || 'Unknown';
                    const statusClass = outcome === 'Failed' ? 'badge-error'
                        : outcome === 'Ended' ? 'badge-success'
                        : outcome === 'Running' ? 'badge-warning'
                        : 'badge-secondary';

                    // Use object_id for display
                    const displayId = bot.object_id || `bot_${bot.bot_id}`;

                    return `
                        <tr onclick="showBotResources('${bot.object_id || bot.bot_id}')">
                            <td><code>${displayId.substring(0, 16)}...</code></td>
                            <td><span class="badge ${statusClass}">${escapeHtml(outcome)}</span></td>
                            <td>
                                <span class="resource-bar-inline"><span class="fill ${memClass}" style="width: ${Math.min(memPct, 100)}%"></span></span>
                                ${bot.peak_memory_mb.toFixed(0)} MB
                            </td>
                            <td>
                                <span class="resource-bar-inline"><span class="fill ${cpuClass}" style="width: ${Math.min(cpuPct, 100)}%"></span></span>
                                ${bot.peak_cpu_millicores.toFixed(0)}m
                            </td>
                            <td>${memLimit} MB</td>
                            <td>${bot.snapshot_count ? bot.snapshot_count + ' snapshots' : '--'}</td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Failed to load resource summary:', error);
            }
        }

        async function showBotResources(botId) {
            const modal = document.getElementById('bot-resource-modal');
            modal.classList.add('visible');
            document.getElementById('modal-bot-id').textContent = botId.substring(0, 20);

            // Clear previous charts
            if (memoryChart) {
                memoryChart.destroy();
                memoryChart = null;
            }
            if (cpuChart) {
                cpuChart.destroy();
                cpuChart = null;
            }

            try {
                const data = await fetch(`/dashboard/api/resources/bot/?bot_id=${botId}`).then(r => r.json());

                // API returns time_series, not snapshots
                const snapshots = data.time_series || [];
                if (snapshots.length === 0) {
                    document.getElementById('modal-peak-mem').textContent = '--';
                    document.getElementById('modal-peak-cpu').textContent = '--';
                    document.getElementById('modal-mem-limit').textContent = '--';
                    document.getElementById('modal-oom').textContent = '--';
                    return;
                }

                // API returns nested peak and limits objects
                const peak = data.peak || {};
                const limits = data.limits || {};

                // Update info grid
                document.getElementById('modal-peak-mem').textContent = (peak.memory_mb || 0).toFixed(0) + ' MB';
                document.getElementById('modal-peak-cpu').textContent = (peak.cpu_millicores || 0).toFixed(0) + 'm';
                document.getElementById('modal-mem-limit').textContent = limits.memory_mb ? limits.memory_mb + ' MB' : '--';

                const memPct = limits.memory_mb > 0 ? (peak.memory_mb / limits.memory_mb) * 100 : 0;
                const oomItem = document.getElementById('modal-oom-item');
                const oomValue = document.getElementById('modal-oom');
                if (memPct > 95) {
                    oomValue.textContent = 'CRITICAL';
                    oomItem.className = 'bot-info-item error';
                } else if (memPct > 85) {
                    oomValue.textContent = 'High';
                    oomItem.className = 'bot-info-item warning';
                } else {
                    oomValue.textContent = 'Low';
                    oomItem.className = 'bot-info-item';
                }

                // Prepare chart data
                const labels = snapshots.map(s => {
                    const d = new Date(s.timestamp);
                    return d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                });
                const memoryData = snapshots.map(s => s.memory_mb);
                const cpuData = snapshots.map(s => s.cpu_millicores);

                // Memory chart
                const memCtx = document.getElementById('memory-chart').getContext('2d');
                memoryChart = new Chart(memCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Memory Usage (MB)',
                                data: memoryData,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: true,
                                tension: 0.3,
                                pointRadius: 2,
                            },
                            limits.memory_mb ? {
                                label: 'Memory Limit',
                                data: Array(labels.length).fill(limits.memory_mb),
                                borderColor: '#ef4444',
                                borderDash: [5, 5],
                                fill: false,
                                pointRadius: 0,
                            } : null
                        ].filter(Boolean)
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'MB' }
                            }
                        }
                    }
                });

                // CPU chart
                const cpuCtx = document.getElementById('cpu-chart').getContext('2d');
                cpuChart = new Chart(cpuCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'CPU Usage (millicores)',
                                data: cpuData,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                fill: true,
                                tension: 0.3,
                                pointRadius: 2,
                            },
                            limits.cpu_millicores ? {
                                label: 'CPU Limit',
                                data: Array(labels.length).fill(limits.cpu_millicores),
                                borderColor: '#ef4444',
                                borderDash: [5, 5],
                                fill: false,
                                pointRadius: 0,
                            } : null
                        ].filter(Boolean)
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'millicores' }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Failed to load bot resources:', error);
            }
        }

        function closeBotModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('bot-resource-modal').classList.remove('visible');
        }

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeBotModal();
        });

        // Infrastructure Status
        let currentMode = 'docker';

        async function loadInfrastructure() {
            try {
                const data = await fetch('/dashboard/api/infrastructure/').then(r => r.json());
                const mode = data.mode || 'docker';
                currentMode = mode;

                // Update mode badge
                const modeBadge = document.getElementById('infra-mode-badge');
                modeBadge.textContent = mode === 'kubernetes' ? 'Kubernetes' : 'Docker';
                modeBadge.className = `badge ${mode === 'kubernetes' ? 'badge-info' : 'badge-secondary'}`;

                // Update log source options based on mode
                await updateLogSourceOptions(mode);

                // Start bot pods refresh in k8s mode
                if (mode === 'kubernetes') {
                    startBotPodsRefresh();
                }

                // Toggle sections based on mode
                const dockerSection = document.getElementById('docker-section');
                const k8sSection = document.getElementById('k8s-section');
                const k8sLookupSection = document.getElementById('k8s-lookup-section');

                if (mode === 'kubernetes') {
                    dockerSection.classList.add('hidden');
                    k8sSection.classList.add('visible');
                    k8sLookupSection.classList.add('visible');

                    // Update K8s stats
                    updateK8sStats(data.kubernetes);

                    // Load K8s alerts, pods, deployments, and events
                    loadK8sAlerts();
                    loadK8sPods();
                    loadK8sDeployments();
                    loadK8sEvents();

                    // Load Hetzner Cloud data
                    loadHetznerData();
                } else {
                    dockerSection.classList.remove('hidden');
                    k8sSection.classList.remove('visible');
                    k8sLookupSection.classList.remove('visible');

                    // Container status
                    const containersRow = document.getElementById('containers-row');
                    const containers = data.containers || [];

                    if (containers.length === 0) {
                        containersRow.innerHTML = '<div class="stat-card"><div class="loading">No containers found</div></div>';
                    } else {
                        containersRow.innerHTML = containers.map(c => {
                            const isRunning = c.status === 'running';
                            const dotClass = isRunning ? 'status-green' : 'status-red';
                            const uptime = c.uptime || (isRunning ? 'Unknown' : 'Stopped');

                            return `
                                <div class="stat-card">
                                    <div class="value"><span class="status-dot ${dotClass}"></span></div>
                                    <div class="label">${escapeHtml(c.name)}</div>
                                    <div class="sublabel">${isRunning ? 'Up ' : ''}${uptime}</div>
                                </div>
                            `;
                        }).join('');
                    }
                }

                // Celery status (shown in both modes) - Enhanced
                const celery = data.celery || {};
                document.getElementById('celery-workers').textContent = celery.workers ?? '--';
                document.getElementById('celery-active').textContent = celery.active_tasks ?? '--';
                document.getElementById('celery-pending').textContent = celery.pending_tasks ?? '--';

                // Worker pod status
                const workerStatus = document.getElementById('celery-worker-status');
                const workerLabel = document.getElementById('celery-worker-label');
                if (celery.workers > 0) {
                    workerStatus.className = 'status-dot status-green';
                    workerLabel.textContent = 'Running';
                } else {
                    workerStatus.className = 'status-dot status-red';
                    workerLabel.textContent = 'Not Running';
                }

                // Redis status (inferred from celery connectivity)
                const redisStatus = document.getElementById('celery-redis-status');
                const redisLabel = document.getElementById('celery-redis-label');
                // If we got celery data, Redis is likely connected
                if (data.celery !== undefined) {
                    redisStatus.className = 'status-dot status-green';
                    redisLabel.textContent = 'Connected';
                } else {
                    redisStatus.className = 'status-dot status-red';
                    redisLabel.textContent = 'Disconnected';
                }

            } catch (error) {
                console.error('Failed to load infrastructure:', error);
                // Set error states for celery status dots
                const workerStatus = document.getElementById('celery-worker-status');
                const redisStatus = document.getElementById('celery-redis-status');
                if (workerStatus) workerStatus.className = 'status-dot status-yellow';
                if (redisStatus) redisStatus.className = 'status-dot status-yellow';
            }
        }

        function updateK8sStats(k8s) {
            if (!k8s) return;

            // API health
            const apiStat = document.getElementById('k8s-api-stat');
            const apiStatus = document.getElementById('k8s-api-status');
            if (k8s.api_healthy) {
                apiStatus.textContent = '✓';
                apiStat.className = 'k8s-stat healthy';
            } else {
                apiStatus.textContent = '✗';
                apiStat.className = 'k8s-stat error';
            }

            // API latency
            document.getElementById('k8s-api-latency').textContent =
                k8s.api_latency_ms ? `${k8s.api_latency_ms}ms` : '--';

            // Pod counts from namespaces
            let totalRunning = 0, totalPending = 0, totalFailed = 0;
            for (const ns of (k8s.namespaces || [])) {
                if (ns.pods) {
                    totalRunning += ns.pods.running || 0;
                    totalPending += ns.pods.pending || 0;
                    totalFailed += ns.pods.failed || 0;
                }
            }

            document.getElementById('k8s-pods-running').textContent = totalRunning;
            document.getElementById('k8s-pods-pending').textContent = totalPending;
            document.getElementById('k8s-pods-failed').textContent = totalFailed;

            // Color code pending/failed
            const pendingStat = document.getElementById('k8s-pods-pending').parentElement;
            pendingStat.className = `k8s-stat ${totalPending > 0 ? 'warning' : ''}`;

            const failedStat = document.getElementById('k8s-pods-failed').parentElement;
            failedStat.className = `k8s-stat ${totalFailed > 0 ? 'error' : ''}`;

            // Nodes
            const nodes = k8s.nodes || {};
            document.getElementById('k8s-nodes-ready').textContent = `${nodes.ready || 0}/${nodes.total || 0}`;

            const nodesStat = document.getElementById('k8s-nodes-ready').parentElement;
            nodesStat.className = `k8s-stat ${nodes.not_ready > 0 ? 'error' : 'healthy'}`;

            // Resource bars
            const resources = k8s.resource_usage;
            if (resources) {
                // CPU
                const cpuPct = resources.cpu_allocatable_millicores > 0
                    ? (resources.cpu_requested_millicores / resources.cpu_allocatable_millicores) * 100
                    : 0;
                document.getElementById('k8s-cpu-pct').textContent = `${cpuPct.toFixed(1)}%`;
                const cpuBar = document.getElementById('k8s-cpu-bar');
                cpuBar.style.width = `${Math.min(cpuPct, 100)}%`;
                cpuBar.className = `resource-bar-fill ${cpuPct > 85 ? 'high' : cpuPct > 60 ? 'medium' : 'low'}`;

                // Memory
                const memPct = resources.memory_allocatable_bytes > 0
                    ? (resources.memory_requested_bytes / resources.memory_allocatable_bytes) * 100
                    : 0;
                document.getElementById('k8s-mem-pct').textContent = `${memPct.toFixed(1)}%`;
                const memBar = document.getElementById('k8s-mem-bar');
                memBar.style.width = `${Math.min(memPct, 100)}%`;
                memBar.className = `resource-bar-fill ${memPct > 85 ? 'high' : memPct > 60 ? 'medium' : 'low'}`;
            }
        }

        async function loadK8sAlerts() {
            try {
                const data = await fetch('/dashboard/api/k8s/alerts/').then(r => r.json());
                const alerts = data.alerts || [];
                const summary = data.summary || { critical: 0, warning: 0 };

                const banner = document.getElementById('k8s-alerts-banner');
                const alertCount = document.getElementById('k8s-alert-count');
                const alertDetail = document.getElementById('k8s-alert-detail');

                const total = summary.critical + summary.warning;
                if (total === 0) {
                    banner.style.display = 'flex';
                    banner.className = 'alert-banner healthy';
                    alertCount.textContent = 'No alerts';
                    alertDetail.textContent = 'Cluster is healthy';
                } else {
                    banner.style.display = 'flex';
                    banner.className = `alert-banner ${summary.critical > 0 ? 'critical' : 'warning'}`;
                    alertCount.textContent = `${total} alert${total !== 1 ? 's' : ''}`;

                    // Show first few alert messages
                    const details = alerts.slice(0, 3).map(a => a.message).join('; ');
                    alertDetail.textContent = details.length > 100 ? details.substring(0, 100) + '...' : details;
                }

            } catch (error) {
                console.error('Failed to load K8s alerts:', error);
            }
        }

        async function loadK8sPods() {
            try {
                const data = await fetch('/dashboard/api/k8s/pods/').then(r => r.json());
                const pods = data.pods || [];
                const issues = data.summary?.by_issue || {};

                const issuesContainer = document.getElementById('k8s-issues-container');
                const issuesBody = document.getElementById('k8s-issues-body');

                // Find pods with issues
                const problemPods = pods.filter(pod => {
                    // Check for restart count > 3
                    if (pod.container_statuses?.some(cs => cs.restart_count > 3)) return true;
                    // Check for waiting state with problem reason
                    if (pod.container_statuses?.some(cs =>
                        cs.state === 'waiting' && ['CrashLoopBackOff', 'ImagePullBackOff', 'ErrImagePull'].includes(cs.reason)
                    )) return true;
                    // Check for OOMKilled
                    if (pod.container_statuses?.some(cs => cs.reason === 'OOMKilled')) return true;
                    // Check for long pending
                    if (pod.phase === 'Pending' && pod.age_seconds > 300) return true;
                    return false;
                });

                if (problemPods.length === 0) {
                    issuesContainer.style.display = 'none';
                } else {
                    issuesContainer.style.display = 'block';
                    issuesBody.innerHTML = problemPods.slice(0, 10).map(pod => {
                        // Determine issue type
                        let issue = 'Unknown';
                        let issueClass = '';

                        for (const cs of (pod.container_statuses || [])) {
                            if (cs.restart_count > 3 || cs.reason === 'CrashLoopBackOff') {
                                issue = `CrashLoop (${cs.restart_count} restarts)`;
                                issueClass = 'issue-crashloop';
                                break;
                            }
                            if (['ImagePullBackOff', 'ErrImagePull'].includes(cs.reason)) {
                                issue = 'ImagePullError';
                                issueClass = 'issue-imagepull';
                                break;
                            }
                            if (cs.reason === 'OOMKilled') {
                                issue = 'OOMKilled';
                                issueClass = 'issue-oom';
                                break;
                            }
                        }

                        if (pod.phase === 'Pending' && pod.age_seconds > 300) {
                            issue = `Pending ${Math.floor(pod.age_seconds / 60)}m`;
                            issueClass = 'issue-pending';
                        }

                        const ageStr = pod.age_seconds
                            ? pod.age_seconds < 60 ? `${pod.age_seconds}s`
                            : pod.age_seconds < 3600 ? `${Math.floor(pod.age_seconds / 60)}m`
                            : `${Math.floor(pod.age_seconds / 3600)}h`
                            : '--';

                        return `
                            <tr>
                                <td><code>${escapeHtml(pod.name.substring(0, 30))}${pod.name.length > 30 ? '...' : ''}</code></td>
                                <td>${escapeHtml(pod.namespace)}</td>
                                <td><span class="issue-reason ${issueClass}">${escapeHtml(issue)}</span></td>
                                <td>${escapeHtml(pod.node) || '-'}</td>
                                <td>${ageStr}</td>
                            </tr>
                        `;
                    }).join('');
                }

            } catch (error) {
                console.error('Failed to load K8s pods:', error);
            }
        }

        async function loadK8sDeployments() {
            try {
                const data = await fetch('/dashboard/api/k8s/deployments/').then(r => r.json());
                if (data.error) {
                    console.error('K8s deployments error:', data.error);
                    return;
                }

                const grid = document.getElementById('k8s-deployments-grid');
                if (!data.deployments || data.deployments.length === 0) {
                    grid.innerHTML = '<div style="color: #666; font-size: 12px;">No deployments found</div>';
                    return;
                }

                grid.innerHTML = data.deployments.map(dep => {
                    const healthClass = dep.health === 'healthy' ? 'healthy' : dep.health === 'degraded' ? 'warning' : 'error';
                    const statusIcon = dep.health === 'healthy' ? '✓' : dep.health === 'degraded' ? '⚠' : '✗';
                    return `
                        <div class="k8s-stat ${healthClass}" style="padding: 12px; border-radius: 8px; background: ${dep.health === 'healthy' ? '#f0fdf4' : dep.health === 'degraded' ? '#fef9c3' : '#fef2f2'};">
                            <div style="font-weight: 600; font-size: 13px; margin-bottom: 4px;">${statusIcon} ${escapeHtml(dep.name)}</div>
                            <div style="font-size: 11px; color: #666;">
                                <span>${dep.replicas.ready}/${dep.replicas.desired} ready</span>
                                ${dep.progressing === false ? '<span style="color: #f59e0b;"> (stalled)</span>' : ''}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Failed to load K8s deployments:', error);
            }
        }

        async function loadK8sEvents() {
            try {
                const data = await fetch('/dashboard/api/k8s/events/').then(r => r.json());
                if (data.error) {
                    console.error('K8s events error:', data.error);
                    return;
                }

                const container = document.getElementById('k8s-events-container');
                const list = document.getElementById('k8s-events-list');
                const warningCount = document.getElementById('k8s-events-warning-count');

                const warnings = data.warnings || [];
                if (warnings.length === 0) {
                    container.style.display = 'none';
                    return;
                }

                container.style.display = 'block';
                warningCount.textContent = `(${warnings.length} warnings)`;

                list.innerHTML = warnings.slice(0, 20).map(evt => {
                    const ageStr = evt.age_seconds
                        ? evt.age_seconds < 60 ? `${evt.age_seconds}s ago`
                        : evt.age_seconds < 3600 ? `${Math.floor(evt.age_seconds / 60)}m ago`
                        : `${Math.floor(evt.age_seconds / 3600)}h ago`
                        : '';
                    const typeClass = evt.type === 'Warning' ? 'color: #f59e0b;' : 'color: #666;';
                    return `
                        <div style="padding: 6px 0; border-bottom: 1px solid #eee; ${typeClass}">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <strong>${escapeHtml(evt.reason)}</strong>
                                    <code style="font-size: 10px; margin-left: 8px;">${escapeHtml(evt.object)}</code>
                                </div>
                                <span style="font-size: 10px; color: #999; white-space: nowrap;">${ageStr}${evt.count > 1 ? ` (x${evt.count})` : ''}</span>
                            </div>
                            <div style="font-size: 11px; color: #666; margin-top: 2px;">${escapeHtml(evt.message.substring(0, 150))}${evt.message.length > 150 ? '...' : ''}</div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Failed to load K8s events:', error);
            }
        }

        // Hetzner Cloud Monitoring
        async function loadHetznerHealth() {
            try {
                const data = await fetch('/dashboard/api/hetzner/health/').then(r => r.json());
                const health = data.health || {};

                // CCM status
                const ccmStat = document.getElementById('hetzner-ccm-stat');
                const ccmStatus = document.getElementById('hetzner-ccm-status');
                if (health.cloud_controller?.status === 'healthy') {
                    ccmStatus.textContent = '✓';
                    ccmStat.className = 'k8s-stat healthy';
                } else {
                    ccmStatus.textContent = '✗';
                    ccmStat.className = 'k8s-stat error';
                }

                // Autoscaler status
                const autoscalerStat = document.getElementById('hetzner-autoscaler-stat');
                const autoscalerStatus = document.getElementById('hetzner-autoscaler-status');
                if (health.autoscaler?.status === 'healthy') {
                    autoscalerStatus.textContent = '✓';
                    autoscalerStat.className = 'k8s-stat healthy';
                } else {
                    autoscalerStatus.textContent = '✗';
                    autoscalerStat.className = 'k8s-stat error';
                }
            } catch (error) {
                console.error('Failed to load Hetzner health:', error);
            }
        }

        async function loadHetznerNodePools() {
            try {
                const data = await fetch('/dashboard/api/hetzner/node-pools/').then(r => r.json());
                const pools = data.pools || [];
                const summary = data.summary || {};

                // Update summary stats
                document.getElementById('hetzner-bot-nodes').textContent = summary.bot_pool_nodes || 0;
                document.getElementById('hetzner-bot-capacity').textContent = summary.total_bot_capacity || 0;

                // Pool grid
                const grid = document.getElementById('hetzner-pools-grid');
                grid.innerHTML = pools.map(pool => {
                    const statusColor = pool.ready === pool.total ? '#10b981' : pool.ready > 0 ? '#f59e0b' : '#ef4444';
                    return `
                        <div style="background: #f8f9fa; border-radius: 6px; padding: 10px;">
                            <div style="font-weight: 600; font-size: 13px; color: #333; margin-bottom: 6px;">${escapeHtml(pool.name)}</div>
                            <div style="display: flex; justify-content: space-between; font-size: 12px;">
                                <span>Nodes:</span>
                                <span style="color: ${statusColor}; font-weight: 500;">${pool.ready}/${pool.total}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 12px;">
                                <span>CPU:</span>
                                <span>${pool.cpu_total}m</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 12px;">
                                <span>Memory:</span>
                                <span>${(pool.memory_total / 1073741824).toFixed(1)}Gi</span>
                            </div>
                            ${pool.name === 'bot-pool' ? `
                            <div style="display: flex; justify-content: space-between; font-size: 12px;">
                                <span>Bot Cap:</span>
                                <span style="font-weight: 500;">${pool.bot_capacity || 0}</span>
                            </div>` : ''}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to load Hetzner node pools:', error);
            }
        }

        async function loadHetznerCosts() {
            try {
                const data = await fetch('/dashboard/api/hetzner/costs/').then(r => r.json());
                const costEl = document.getElementById('hetzner-cost-hourly');
                costEl.textContent = data.total_hourly_eur?.toFixed(3) || '--';
            } catch (error) {
                console.error('Failed to load Hetzner costs:', error);
            }
        }

        async function loadHetznerAutoscaler() {
            try {
                const data = await fetch('/dashboard/api/hetzner/autoscaler/').then(r => r.json());
                const events = data.recent_events || [];
                const container = document.getElementById('hetzner-events-container');
                const list = document.getElementById('hetzner-events-list');
                const countEl = document.getElementById('hetzner-events-count');

                if (events.length === 0) {
                    container.style.display = 'none';
                    return;
                }

                container.style.display = 'block';
                countEl.textContent = `(${events.length} events)`;

                list.innerHTML = events.slice(0, 10).map(evt => {
                    const ageStr = evt.age_seconds
                        ? evt.age_seconds < 60 ? `${evt.age_seconds}s ago`
                        : evt.age_seconds < 3600 ? `${Math.floor(evt.age_seconds / 60)}m ago`
                        : `${Math.floor(evt.age_seconds / 3600)}h ago`
                        : '';
                    const isScaleUp = evt.reason?.includes('ScaleUp') || evt.reason?.includes('scale up');
                    const color = isScaleUp ? '#10b981' : '#f59e0b';
                    return `
                        <div style="padding: 4px 0; border-bottom: 1px solid #eee; font-size: 12px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: ${color}; font-weight: 500;">${escapeHtml(evt.reason || 'Event')}</span>
                                <span style="color: #999; font-size: 10px;">${ageStr}</span>
                            </div>
                            <div style="color: #666; font-size: 11px;">${escapeHtml((evt.message || '').substring(0, 100))}${(evt.message?.length || 0) > 100 ? '...' : ''}</div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to load Hetzner autoscaler:', error);
            }
        }

        async function loadHetznerData() {
            await Promise.all([
                loadHetznerHealth(),
                loadHetznerNodePools(),
                loadHetznerCosts(),
                loadHetznerAutoscaler()
            ]);
        }

        async function doK8sLookup() {
            const input = document.getElementById('k8s-lookup-input').value.trim();
            if (!input) return;

            const resultDiv = document.getElementById('k8s-lookup-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading">Searching...</div>';

            try {
                const param = input.startsWith('bot_') ? 'bot_id' : 'pod_name';
                const data = await fetch(`/dashboard/api/k8s/bot-lookup/?${param}=${encodeURIComponent(input)}`).then(r => r.json());

                if (!data.found) {
                    resultDiv.innerHTML = '<div class="lookup-result"><p>No results found for: ' + escapeHtml(input) + '</p></div>';
                    return;
                }

                let html = '<div class="lookup-result">';

                // Bot info
                if (data.bot) {
                    html += '<h4>Bot Record</h4>';
                    html += `
                        <div class="detail-row"><span class="detail-label">Object ID:</span><span class="detail-value"><code>${escapeHtml(data.bot.object_id)}</code></span></div>
                        <div class="detail-row"><span class="detail-label">State:</span><span class="detail-value"><span class="badge ${getBadgeClass(data.bot.state)}">${escapeHtml(data.bot.state)}</span></span></div>
                        <div class="detail-row"><span class="detail-label">Meeting URL:</span><span class="detail-value">${escapeHtml(data.bot.meeting_url) || '-'}</span></div>
                        <div class="detail-row"><span class="detail-label">Last Heartbeat:</span><span class="detail-value">${data.bot.heartbeat_age_seconds !== null ? data.bot.heartbeat_age_seconds + 's ago' : 'Never'}</span></div>
                        <div class="detail-row"><span class="detail-label">Join At:</span><span class="detail-value">${data.bot.join_at ? new Date(data.bot.join_at).toLocaleString() : '-'}</span></div>
                    `;

                    if (data.events && data.events.length > 0) {
                        html += '<h4 style="margin-top: 12px;">Recent Bot Events</h4>';
                        html += '<div class="events-list">';
                        for (const e of data.events) {
                            html += `<div class="event-item">${new Date(e.timestamp).toLocaleTimeString()} - ${escapeHtml(e.type)}</div>`;
                        }
                        html += '</div>';
                    }
                }

                // Pod info
                if (data.pod) {
                    html += '<h4 style="margin-top: 16px;">Kubernetes Pod</h4>';
                    html += `
                        <div class="detail-row"><span class="detail-label">Pod Name:</span><span class="detail-value"><code>${escapeHtml(data.pod.name)}</code></span></div>
                        <div class="detail-row"><span class="detail-label">Namespace:</span><span class="detail-value">${escapeHtml(data.pod.namespace)}</span></div>
                        <div class="detail-row"><span class="detail-label">Phase:</span><span class="detail-value"><span class="badge ${data.pod.phase === 'Running' ? 'badge-success' : 'badge-warning'}">${escapeHtml(data.pod.phase)}</span></span></div>
                        <div class="detail-row"><span class="detail-label">Node:</span><span class="detail-value">${escapeHtml(data.pod.node) || '-'}</span></div>
                        <div class="detail-row"><span class="detail-label">Created:</span><span class="detail-value">${data.pod.created ? new Date(data.pod.created).toLocaleString() : '-'}</span></div>
                    `;

                    if (data.pod.events && data.pod.events.length > 0) {
                        html += '<h4 style="margin-top: 12px;">Recent K8s Events</h4>';
                        html += '<div class="events-list">';
                        for (const e of data.pod.events) {
                            const eventClass = e.type === 'Warning' ? 'badge-warning' : 'badge-info';
                            html += `<div class="event-item"><span class="badge ${eventClass}">${e.type}</span> ${escapeHtml(e.reason)}: ${escapeHtml(e.message)}</div>`;
                        }
                        html += '</div>';
                    }
                }

                if (data.pod_error) {
                    html += `<p style="color: #dc3545; margin-top: 12px;">Pod lookup error: ${escapeHtml(data.pod_error)}</p>`;
                }

                html += '</div>';
                resultDiv.innerHTML = html;

            } catch (error) {
                console.error('Failed to lookup bot/pod:', error);
                resultDiv.innerHTML = '<div class="lookup-result"><p style="color: #dc3545;">Lookup failed: ' + escapeHtml(error.message) + '</p></div>';
            }
        }

        // Allow enter key in lookup input
        document.getElementById('k8s-lookup-input')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') doK8sLookup();
        });

        // Live Logs Stream
        let logEventSource = null;
        let logPaused = false;
        let logLineCount = 0;
        let autoScroll = true;
        const MAX_LOG_LINES = 500;

        // Cache for bot pods
        let cachedBotPods = [];

        async function fetchBotPods() {
            try {
                const response = await fetch('/dashboard/api/kubernetes/pods');
                if (!response.ok) return [];
                const data = await response.json();
                // Include all bot pods (Running, Error, Completed) for visibility
                return (data.pods || []).filter(p =>
                    p.name.startsWith('bot-') || p.name.startsWith('bot-pod-')
                ).sort((a, b) => {
                    // Sort: Running first, then by name
                    if (a.phase === 'Running' && b.phase !== 'Running') return -1;
                    if (a.phase !== 'Running' && b.phase === 'Running') return 1;
                    return a.name.localeCompare(b.name);
                });
            } catch (e) {
                console.error('Failed to fetch bot pods:', e);
                return [];
            }
        }

        async function updateLogSourceOptions(mode) {
            const logSource = document.getElementById('log-source');
            const currentValue = logSource.value;

            if (mode === 'kubernetes') {
                // Fetch all bot pods (including non-running for error visibility)
                cachedBotPods = await fetchBotPods();

                let options = `
                    <option value="all-bots">All Bot Pods (aggregated)</option>
                    <option value="scheduler">scheduler (k8s)</option>
                    <option value="app">api (k8s)</option>
                `;

                // Add individual bot pod options
                if (cachedBotPods.length > 0) {
                    options += `<optgroup label="Bot Pods (${cachedBotPods.length})">`;
                    for (const pod of cachedBotPods) {
                        const status = pod.phase !== 'Running' ? ` [${pod.phase}]` : '';
                        options += `<option value="${pod.name}">${pod.name}${status}</option>`;
                    }
                    options += `</optgroup>`;
                }

                logSource.innerHTML = options;

                // Set to scheduler if current value doesn't exist in k8s options (e.g., worker)
                if (currentValue && logSource.querySelector(`option[value="${currentValue}"]`)) {
                    logSource.value = currentValue;
                } else {
                    logSource.value = 'scheduler';  // Default to scheduler in k8s mode
                }
            } else {
                logSource.innerHTML = `
                    <option value="worker">worker</option>
                    <option value="scheduler">scheduler</option>
                    <option value="app">app</option>
                `;
            }
        }

        // Refresh bot pods list periodically in k8s mode
        function startBotPodsRefresh() {
            setInterval(async () => {
                const mode = document.body.dataset.infraMode;
                if (mode === 'kubernetes') {
                    const logSource = document.getElementById('log-source');
                    const currentValue = logSource.value;
                    // Only refresh if not currently viewing a bot pod
                    if (!currentValue.startsWith('bot-')) {
                        await updateLogSourceOptions('kubernetes');
                    }
                }
            }, 30000); // Refresh every 30 seconds
        }

        function initLogStream() {
            const source = document.getElementById('log-source').value;
            const level = document.getElementById('log-level').value;

            // Close existing connection
            if (logEventSource) {
                logEventSource.close();
            }

            const logContainer = document.getElementById('log-container');
            logContainer.innerHTML = '';
            logLineCount = 0;
            updateLogStatus('Connecting...');

            logEventSource = new EventSource(`/dashboard/api/logs/stream?source=${source}&level=${level}`);

            logEventSource.onopen = () => {
                updateLogStatus('Connected - Auto-scrolling');
            };

            logEventSource.onmessage = (event) => {
                if (logPaused) return;

                try {
                    const data = JSON.parse(event.data);

                    if (data.error) {
                        addLogLine('--:--:--', 'ERROR', data.error);
                        return;
                    }

                    addLogLine(data.time || '--:--:--', data.level || 'INFO', data.message || '');
                } catch (e) {
                    // Raw text log line
                    addLogLine('--:--:--', 'INFO', event.data);
                }
            };

            logEventSource.onerror = () => {
                updateLogStatus('Disconnected - Reconnecting...');
            };
        }

        function addLogLine(time, level, message) {
            const logContainer = document.getElementById('log-container');

            // Remove oldest lines if at max
            while (logContainer.children.length >= MAX_LOG_LINES) {
                logContainer.removeChild(logContainer.firstChild);
            }

            const levelClass = level === 'ERROR' || level === 'CRITICAL' ? 'log-error'
                             : level === 'WARNING' ? 'log-warning'
                             : 'log-info';

            const badgeClass = level === 'ERROR' || level === 'CRITICAL' ? 'badge-error'
                             : level === 'WARNING' ? 'badge-warning'
                             : 'badge-info';

            const line = document.createElement('div');
            line.className = `log-line ${levelClass}`;
            line.innerHTML = `
                <span class="log-time">${escapeHtml(time)}</span>
                <span class="badge ${badgeClass}">${level}</span>
                <span class="log-msg">${escapeHtml(message)}</span>
            `;

            logContainer.appendChild(line);
            logLineCount++;
            document.getElementById('log-count').textContent = `${logLineCount} lines`;

            // Auto-scroll if enabled
            if (autoScroll) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        function updateLogStatus(status) {
            document.getElementById('log-status').textContent = status;
        }

        // Log controls
        document.getElementById('log-pause').addEventListener('click', function() {
            logPaused = !logPaused;
            this.textContent = logPaused ? 'Resume' : 'Pause';
            updateLogStatus(logPaused ? 'Paused' : 'Connected - Auto-scrolling');
        });

        document.getElementById('log-clear').addEventListener('click', function() {
            document.getElementById('log-container').innerHTML = '';
            logLineCount = 0;
            document.getElementById('log-count').textContent = '0 lines';
        });

        document.getElementById('log-source').addEventListener('change', initLogStream);
        document.getElementById('log-level').addEventListener('change', initLogStream);

        // Detect manual scroll to disable auto-scroll
        document.getElementById('log-container').addEventListener('scroll', function() {
            const isAtBottom = this.scrollHeight - this.scrollTop <= this.clientHeight + 50;
            autoScroll = isAtBottom;
            if (!logPaused) {
                updateLogStatus(autoScroll ? 'Connected - Auto-scrolling' : 'Connected - Scroll paused');
            }
        });

        // Initial load
        loadData();
        initLogStream();

        // Auto-refresh every 30 seconds (except logs which stream continuously)
        setInterval(loadData, 30000);
    </script>
</body>
</html>
