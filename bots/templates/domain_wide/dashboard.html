<!DOCTYPE html>
<html>
<head>
    <title>Meeting Recorder - Health Dashboard</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            color: #333;
        }
        h1 { margin-bottom: 20px; font-size: 24px; }
        h2 { font-size: 16px; margin-bottom: 12px; color: #666; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .refresh-btn {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .refresh-btn:hover { background: #0056b3; }
        .last-updated { color: #888; font-size: 13px; }

        /* All-time stats row */
        .stats-row {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            flex: 1;
            text-align: center;
        }
        .stat-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }
        .stat-card .label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        .stat-card .arrow {
            font-size: 20px;
            color: #ccc;
            margin: 0 -8px;
        }
        .stat-card.highlight .value { color: #28a745; }

        .card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 16px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .card-header h2 { margin: 0; }
        .card-header input[type="date"] {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th { font-weight: 600; color: #666; background: #fafafa; }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-error { background: #f8d7da; color: #721c24; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        .badge-secondary { background: #e2e3e5; color: #383d41; }

        .pipeline-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            padding: 12px 0;
        }
        .pipeline-col {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px 16px;
        }
        .pipeline-col h3 {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }
        .metric-label {
            font-size: 13px;
            color: #555;
        }
        .metric-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        .metric-error {
            color: #dc3545;
        }
        #bot-health-breakdown .metric-row {
            font-size: 12px;
        }
        #bot-health-breakdown .badge {
            margin-right: 4px;
        }

        .two-col {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 16px;
        }

        .loading { color: #888; font-style: italic; }

        .url-cell {
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .events-table-container {
            max-height: 500px;
            overflow-y: auto;
        }

        .count-badge {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 8px;
        }

        /* Calendar Sync Health */
        .row-error { background: #fff5f5; }
        .error-text { color: #dc3545; font-size: 12px; max-width: 300px; }

        /* Infrastructure Status */
        .status-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .status-green { background: #28a745; }
        .status-yellow { background: #ffc107; }
        .status-red { background: #dc3545; }
        .sublabel { font-size: 11px; color: #888; margin-top: 2px; }

        /* Live Logs */
        .log-controls { display: flex; gap: 8px; align-items: center; }
        .log-select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        .log-container {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            padding: 12px;
            border-radius: 4px;
            height: 400px;
            overflow-y: auto;
        }
        .log-line { padding: 2px 0; white-space: nowrap; }
        .log-line:hover { background: #2d2d2d; }
        .log-time { color: #888; margin-right: 8px; }
        .log-msg { color: #d4d4d4; }
        .log-error .log-msg { color: #f48771; }
        .log-warning .log-msg { color: #dcdcaa; }
        .log-footer {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 12px;
            color: #888;
        }

        /* Kubernetes Monitoring */
        .k8s-section { display: none; }
        .k8s-section.visible { display: block; }
        .docker-section { display: block; }
        .docker-section.hidden { display: none; }

        .alert-banner {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .alert-banner.critical {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #dc2626;
        }
        .alert-banner.warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #d97706;
        }
        .alert-banner.healthy {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #059669;
        }
        .alert-icon { font-size: 20px; }
        .alert-count { font-weight: 600; }
        .alert-detail { font-size: 13px; opacity: 0.9; }

        .k8s-stats-row {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        .k8s-stat {
            background: white;
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-align: center;
        }
        .k8s-stat .value { font-size: 24px; font-weight: bold; color: #333; }
        .k8s-stat .label { font-size: 11px; color: #666; margin-top: 4px; }
        .k8s-stat.healthy .value { color: #10b981; }
        .k8s-stat.warning .value { color: #f59e0b; }
        .k8s-stat.error .value { color: #ef4444; }

        .resource-bar-container {
            margin-bottom: 12px;
        }
        .resource-bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        .resource-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        .resource-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .resource-bar-fill.low { background: #10b981; }
        .resource-bar-fill.medium { background: #f59e0b; }
        .resource-bar-fill.high { background: #ef4444; }

        .issues-table { margin-top: 12px; }
        .issues-table td, .issues-table th { padding: 8px 12px; font-size: 13px; }
        .issue-reason {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
        }
        .issue-crashloop { background: #fee2e2; color: #dc2626; }
        .issue-imagepull { background: #fef3c7; color: #d97706; }
        .issue-oom { background: #e0e7ff; color: #4f46e5; }
        .issue-pending { background: #dbeafe; color: #2563eb; }

        .lookup-form {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 16px;
        }
        .lookup-form input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            width: 250px;
        }
        .lookup-form button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .lookup-form button:hover { background: #0056b3; }

        .lookup-result {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
        }
        .lookup-result h4 { margin-bottom: 12px; font-size: 14px; color: #333; }
        .lookup-result .detail-row {
            display: flex;
            padding: 4px 0;
            font-size: 13px;
        }
        .lookup-result .detail-label {
            width: 140px;
            color: #666;
            flex-shrink: 0;
        }
        .lookup-result .detail-value {
            color: #333;
            word-break: break-all;
        }
        .lookup-result .events-list {
            margin-top: 8px;
            max-height: 150px;
            overflow-y: auto;
        }
        .lookup-result .event-item {
            padding: 4px 0;
            font-size: 12px;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Meeting Recorder Health Dashboard</h1>
            <div class="header-right">
                <span class="last-updated" id="last-updated">Loading...</span>
                <button class="refresh-btn" onclick="loadData()">Refresh</button>
            </div>
        </div>

        <!-- Section 1: All-Time Stats -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="value" id="total-events">--</div>
                <div class="label">Total Events</div>
            </div>
            <div class="stat-card">
                <div class="arrow">-></div>
            </div>
            <div class="stat-card">
                <div class="value" id="events-with-url">--</div>
                <div class="label">Events with URL</div>
            </div>
            <div class="stat-card">
                <div class="arrow">-></div>
            </div>
            <div class="stat-card">
                <div class="value" id="unique-events">--</div>
                <div class="label">Unique Events (deduped)</div>
            </div>
            <div class="stat-card">
                <div class="arrow">-></div>
            </div>
            <div class="stat-card">
                <div class="value" id="active-bots">--</div>
                <div class="label">Active Bots</div>
            </div>
            <div class="stat-card">
                <div class="arrow">-></div>
            </div>
            <div class="stat-card highlight">
                <div class="value" id="coverage-rate">--</div>
                <div class="label">Coverage</div>
            </div>
        </div>

        <!-- Section 2: Bot States (All-Time) -->
        <div class="card">
            <div class="card-header">
                <h2>Bot States (Active)</h2>
                <span style="color:#888;font-size:13px;">Total bots in DB: <span id="total-bots">--</span></span>
            </div>
            <table id="states-table">
                <thead>
                    <tr>
                        <th>State</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody id="states-body">
                    <tr><td colspan="3" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Section 3: Pipeline Status (Per Date) -->
        <div class="card">
            <div class="card-header">
                <h2>Pipeline Status</h2>
                <input type="date" id="date-picker" onchange="loadDateData()">
            </div>
            <div class="pipeline-grid">
                <div class="pipeline-col">
                    <h3>Pipeline</h3>
                    <div class="metric-row">
                        <span class="metric-label">Events</span>
                        <span class="metric-value" id="pipe-events">--</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Bots Created</span>
                        <span class="metric-value" id="pipe-bots">--</span>
                    </div>
                </div>
                <div class="pipeline-col">
                    <h3>Bot Health</h3>
                    <div id="bot-health-breakdown">
                        <span class="loading">Loading...</span>
                    </div>
                </div>
                <div class="pipeline-col">
                    <h3>Recordings</h3>
                    <div class="metric-row">
                        <span class="metric-label">Complete</span>
                        <span class="metric-value" id="recordings-complete">--</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Failed</span>
                        <span class="metric-value metric-error" id="recordings-failed">--</span>
                    </div>
                </div>
                <div class="pipeline-col">
                    <h3>Transcriptions</h3>
                    <div class="metric-row">
                        <span class="metric-label">Complete</span>
                        <span class="metric-value" id="transcriptions-complete">--</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Failed</span>
                        <span class="metric-value metric-error" id="transcriptions-failed">--</span>
                    </div>
                </div>
                <div class="pipeline-col">
                    <h3>Durations</h3>
                    <div class="metric-row">
                        <span class="metric-label">Avg Meeting</span>
                        <span class="metric-value" id="avg-meeting-duration">--</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Avg Recording</span>
                        <span class="metric-value" id="avg-recording-duration">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 4: Events & Bots List (Per Date) -->
        <div class="card">
            <div class="card-header">
                <h2>Events & Bots <span class="count-badge" id="events-count">0</span></h2>
                <span style="color:#666;font-size:13px;">Unique meetings with URL (deduped)</span>
            </div>
            <div class="events-table-container">
                <table id="events-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Title</th>
                            <th>Meeting URL</th>
                            <th>Calendar Owner</th>
                            <th>Bot ID</th>
                            <th>Bot Status</th>
                            <th>Attendees</th>
                        </tr>
                    </thead>
                    <tbody id="events-body">
                        <tr><td colspan="7" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Recent Failures -->
        <div class="card">
            <div class="card-header">
                <h2>Recent Failures (Last 7 Days)</h2>
                <span class="count-badge" id="failure-count">0 failures</span>
            </div>

            <!-- Failure breakdown by reason -->
            <div class="pipeline-grid" id="failure-summary" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); margin-bottom: 16px;">
                <span class="loading">Loading...</span>
            </div>

            <table id="failures-table">
                <thead>
                    <tr>
                        <th>Bot ID</th>
                        <th>Event Type</th>
                        <th>Reason</th>
                        <th>Meeting URL</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="failures-body">
                    <tr><td colspan="5" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Calendar Sync Health -->
        <div class="card">
            <div class="card-header">
                <h2>Calendar Sync Health</h2>
                <span class="count-badge" id="calendar-count">0 calendars</span>
            </div>
            <table>
                <thead>
                    <tr><th>Calendar</th><th>Owner</th><th>Status</th><th>Last Sync</th><th>Details</th></tr>
                </thead>
                <tbody id="calendar-sync-body">
                    <tr><td colspan="5" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Infrastructure Status -->
        <div class="card">
            <div class="card-header">
                <h2>Infrastructure</h2>
                <span id="infra-mode-badge" class="badge badge-info">--</span>
            </div>

            <!-- Docker Container Status Row (hidden in K8s mode) -->
            <div class="docker-section" id="docker-section">
                <div class="stats-row" id="containers-row" style="margin-bottom: 16px;">
                    <div class="stat-card">
                        <div class="loading">Loading containers...</div>
                    </div>
                </div>
            </div>

            <!-- Kubernetes Section (hidden in Docker mode) -->
            <div class="k8s-section" id="k8s-section">
                <!-- K8s Alerts Banner -->
                <div id="k8s-alerts-banner" class="alert-banner healthy" style="display: none;">
                    <span class="alert-icon">⚠️</span>
                    <span class="alert-count" id="k8s-alert-count">0 alerts</span>
                    <span class="alert-detail" id="k8s-alert-detail"></span>
                </div>

                <!-- K8s Stats Row -->
                <div class="k8s-stats-row">
                    <div class="k8s-stat" id="k8s-api-stat">
                        <div class="value" id="k8s-api-status">--</div>
                        <div class="label">API Health</div>
                    </div>
                    <div class="k8s-stat">
                        <div class="value" id="k8s-pods-running">--</div>
                        <div class="label">Pods Running</div>
                    </div>
                    <div class="k8s-stat">
                        <div class="value" id="k8s-pods-pending">--</div>
                        <div class="label">Pods Pending</div>
                    </div>
                    <div class="k8s-stat">
                        <div class="value" id="k8s-pods-failed">--</div>
                        <div class="label">Pods Failed</div>
                    </div>
                    <div class="k8s-stat">
                        <div class="value" id="k8s-nodes-ready">--</div>
                        <div class="label">Nodes Ready</div>
                    </div>
                    <div class="k8s-stat">
                        <div class="value" id="k8s-api-latency">--</div>
                        <div class="label">API Latency</div>
                    </div>
                </div>

                <!-- Resource Bars -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div class="resource-bar-container">
                        <div class="resource-bar-label">
                            <span>CPU Usage</span>
                            <span id="k8s-cpu-pct">--%</span>
                        </div>
                        <div class="resource-bar">
                            <div class="resource-bar-fill low" id="k8s-cpu-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="resource-bar-container">
                        <div class="resource-bar-label">
                            <span>Memory Usage</span>
                            <span id="k8s-mem-pct">--%</span>
                        </div>
                        <div class="resource-bar">
                            <div class="resource-bar-fill low" id="k8s-mem-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <!-- Pod Issues Table -->
                <div id="k8s-issues-container" style="display: none;">
                    <h3 style="font-size: 14px; color: #666; margin-bottom: 8px;">Pod Issues</h3>
                    <table class="issues-table">
                        <thead>
                            <tr>
                                <th>Pod</th>
                                <th>Namespace</th>
                                <th>Issue</th>
                                <th>Node</th>
                                <th>Age</th>
                            </tr>
                        </thead>
                        <tbody id="k8s-issues-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Celery Queue (shown in both modes) -->
            <div class="pipeline-grid" style="grid-template-columns: repeat(4, 1fr);">
                <div class="pipeline-col">
                    <h3>Workers</h3>
                    <div class="metric-row">
                        <span class="metric-value" id="celery-workers">--</span>
                    </div>
                </div>
                <div class="pipeline-col">
                    <h3>Active Tasks</h3>
                    <div class="metric-row">
                        <span class="metric-value" id="celery-active">--</span>
                    </div>
                </div>
                <div class="pipeline-col">
                    <h3>Pending</h3>
                    <div class="metric-row">
                        <span class="metric-value" id="celery-pending">--</span>
                    </div>
                </div>
                <div class="pipeline-col">
                    <h3>Failed (24h)</h3>
                    <div class="metric-row">
                        <span class="metric-value metric-error" id="celery-failed">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Kubernetes Bot/Pod Lookup (only shown in K8s mode) -->
        <div class="card k8s-section" id="k8s-lookup-section">
            <div class="card-header">
                <h2>Bot/Pod Lookup</h2>
            </div>
            <div class="lookup-form">
                <input type="text" id="k8s-lookup-input" placeholder="Enter bot_id or pod_name">
                <button onclick="doK8sLookup()">Search</button>
            </div>
            <div id="k8s-lookup-result" style="display: none;"></div>
        </div>

        <!-- Live Logs Stream -->
        <div class="card">
            <div class="card-header">
                <h2>Live Logs</h2>
                <div class="log-controls">
                    <select id="log-source" class="log-select">
                        <option value="worker">worker</option>
                        <option value="scheduler">scheduler</option>
                        <option value="app">app</option>
                    </select>
                    <select id="log-level" class="log-select">
                        <option value="INFO">INFO+</option>
                        <option value="WARNING">WARNING+</option>
                        <option value="ERROR">ERROR only</option>
                    </select>
                    <button class="refresh-btn" id="log-pause">Pause</button>
                    <button class="refresh-btn" id="log-clear" style="background:#6c757d;">Clear</button>
                </div>
            </div>

            <div class="log-container" id="log-container">
                <div class="log-line log-info">
                    <span class="log-time">--:--:--</span>
                    <span class="badge badge-info">INFO</span>
                    <span class="log-msg">Connecting to log stream...</span>
                </div>
            </div>

            <div class="log-footer">
                <span id="log-status">Connecting...</span>
                <span id="log-count">0 lines</span>
            </div>
        </div>
    </div>

    <script>
        // Set default date to today
        document.getElementById('date-picker').valueAsDate = new Date();

        async function loadData() {
            await Promise.all([loadSummary(), loadDateData(), loadFailures(), loadCalendarSync(), loadInfrastructure()]);
        }

        async function loadSummary() {
            try {
                const summary = await fetch('/dashboard/api/summary/').then(r => r.json());

                // Update timestamp
                document.getElementById('last-updated').textContent =
                    `Updated: ${new Date(summary.timestamp).toLocaleTimeString()}`;

                // All-time stats
                document.getElementById('total-events').textContent = summary.all_time.total_events.toLocaleString();
                document.getElementById('events-with-url').textContent = summary.all_time.events_with_url.toLocaleString();
                document.getElementById('unique-events').textContent = summary.all_time.unique_events_deduped.toLocaleString();
                document.getElementById('active-bots').textContent = summary.all_time.active_bots.toLocaleString();
                document.getElementById('total-bots').textContent = summary.all_time.total_bots.toLocaleString();
                document.getElementById('coverage-rate').textContent = `${summary.all_time.coverage_rate}%`;

                // Bot states table
                const statesBody = document.getElementById('states-body');
                const total = summary.all_time.active_bots || 1;
                statesBody.innerHTML = Object.entries(summary.bot_states)
                    .sort((a, b) => b[1] - a[1])
                    .map(([state, count]) => `
                        <tr>
                            <td><span class="badge ${getBadgeClass(state)}">${state}</span></td>
                            <td>${count.toLocaleString()}</td>
                            <td>${(count / total * 100).toFixed(1)}%</td>
                        </tr>
                    `).join('');

            } catch (error) {
                console.error('Failed to load summary:', error);
            }
        }

        async function loadDateData() {
            const date = document.getElementById('date-picker').value;

            try {
                const [pipeline, events] = await Promise.all([
                    fetch(`/dashboard/api/pipeline/?date=${date}`).then(r => r.json()),
                    fetch(`/dashboard/api/events/?date=${date}`).then(r => r.json()),
                ]);

                // Pipeline basics
                document.getElementById('pipe-events').textContent = pipeline.unique_events;
                document.getElementById('pipe-bots').textContent = pipeline.bots_created;

                // Bot health breakdown
                const healthDiv = document.getElementById('bot-health-breakdown');
                const states = Object.entries(pipeline.bot_states || {});
                if (states.length === 0) {
                    healthDiv.innerHTML = '<span style="color:#888;font-size:12px;">No bots</span>';
                } else {
                    healthDiv.innerHTML = states
                        .sort((a, b) => b[1] - a[1])
                        .map(([state, count]) => `
                            <div class="metric-row">
                                <span class="badge ${getBadgeClass(state)}">${state}</span>
                                <span>${count}</span>
                            </div>
                        `).join('');
                }

                // Recordings
                document.getElementById('recordings-complete').textContent = pipeline.recordings?.complete ?? '--';
                document.getElementById('recordings-failed').textContent = pipeline.recordings?.failed ?? '--';

                // Transcriptions
                document.getElementById('transcriptions-complete').textContent = pipeline.transcriptions?.complete ?? '--';
                document.getElementById('transcriptions-failed').textContent = pipeline.transcriptions?.failed ?? '--';

                // Durations
                document.getElementById('avg-meeting-duration').textContent =
                    pipeline.avg_meeting_duration_mins ? `${pipeline.avg_meeting_duration_mins} min` : '--';
                document.getElementById('avg-recording-duration').textContent =
                    pipeline.avg_recording_duration_mins ? `${pipeline.avg_recording_duration_mins} min` : '--';

                // Events list
                document.getElementById('events-count').textContent = events.count;
                const eventsBody = document.getElementById('events-body');

                if (events.events.length === 0) {
                    eventsBody.innerHTML = '<tr><td colspan="7">No events for this date</td></tr>';
                } else {
                    eventsBody.innerHTML = events.events.map(e => `
                        <tr>
                            <td>${e.time}</td>
                            <td>${escapeHtml(e.title)}</td>
                            <td class="url-cell" title="${escapeHtml(e.meeting_url)}">${e.meeting_url}</td>
                            <td>${escapeHtml(e.calendar_owner)}</td>
                            <td>${e.bot_id ? `<code>${e.bot_id.substring(0, 8)}...</code>` : '<span class="badge badge-secondary">None</span>'}</td>
                            <td>${e.bot_status ? `<span class="badge ${getBadgeClass(e.bot_status)}">${e.bot_status}</span>` : '-'}</td>
                            <td>${e.attendees_count}</td>
                        </tr>
                    `).join('');
                }

            } catch (error) {
                console.error('Failed to load date data:', error);
            }
        }

        // Unique colors for failure reasons
        const failureReasonColors = {
            'Request Denied': { bg: '#fee2e2', border: '#ef4444', text: '#dc2626' },
            'Waiting Room Timeout': { bg: '#fef3c7', border: '#f59e0b', text: '#d97706' },
            'Not Found': { bg: '#dbeafe', border: '#3b82f6', text: '#2563eb' },
            'Invalid URL': { bg: '#e0e7ff', border: '#6366f1', text: '#4f46e5' },
            'Requires Sign In': { bg: '#fce7f3', border: '#ec4899', text: '#db2777' },
            'Requires Passcode': { bg: '#f3e8ff', border: '#a855f7', text: '#9333ea' },
            'Room Full': { bg: '#ffedd5', border: '#f97316', text: '#ea580c' },
            'Not Started': { bg: '#d1fae5', border: '#10b981', text: '#059669' },
            'Has Ended': { bg: '#e5e7eb', border: '#6b7280', text: '#4b5563' },
            'Account Not Found': { bg: '#fef9c3', border: '#eab308', text: '#ca8a04' },
            'Generic Error': { bg: '#f1f5f9', border: '#64748b', text: '#475569' },
            'Heartbeat Timeout': { bg: '#fecaca', border: '#f87171', text: '#dc2626' },
        };
        const defaultFailureColor = { bg: '#f8d7da', border: '#dc3545', text: '#721c24' };

        function getFailureColor(reason) {
            return failureReasonColors[reason] || defaultFailureColor;
        }

        async function loadFailures() {
            try {
                const data = await fetch('/dashboard/api/failures/').then(r => r.json());

                // Update total count
                document.getElementById('failure-count').textContent = `${data.total} failures`;

                // Render summary counts
                const summaryDiv = document.getElementById('failure-summary');
                const summaryEntries = Object.entries(data.summary || {});
                if (summaryEntries.length === 0) {
                    summaryDiv.innerHTML = '<span style="color:#888;font-size:13px;">No failures</span>';
                } else {
                    summaryDiv.innerHTML = summaryEntries
                        .sort((a, b) => b[1] - a[1])
                        .map(([reason, count]) => {
                            const color = getFailureColor(reason);
                            return `
                            <div class="pipeline-col">
                                <h3><span class="badge" style="background:${color.bg}; color:${color.text}; border: 1px solid ${color.border};">${escapeHtml(reason)}</span></h3>
                                <div class="metric-row">
                                    <span class="metric-value metric-error">${count}</span>
                                </div>
                            </div>
                        `}).join('');
                }

                // Render table with new columns
                const failuresBody = document.getElementById('failures-body');
                if (data.failures.length === 0) {
                    failuresBody.innerHTML = '<tr><td colspan="5">No failures in the last 7 days</td></tr>';
                } else {
                    failuresBody.innerHTML = data.failures.slice(0, 20).map(f => {
                        const color = getFailureColor(f.reason);
                        return `
                        <tr>
                            <td><code>${f.bot_id.substring(0, 8)}...</code></td>
                            <td><span class="badge ${f.event_type_label === 'Fatal Error' ? 'badge-error' : 'badge-warning'}">${escapeHtml(f.event_type_label)}</span></td>
                            <td><span class="badge" style="background:${color.bg}; color:${color.text}; border: 1px solid ${color.border};">${escapeHtml(f.reason)}</span></td>
                            <td class="url-cell" title="${escapeHtml(f.meeting_url)}">${f.meeting_url || '-'}</td>
                            <td>${new Date(f.timestamp).toLocaleString()}</td>
                        </tr>
                    `}).join('');
                }
            } catch (error) {
                console.error('Failed to load failures:', error);
            }
        }

        function getBadgeClass(state) {
            if (state === 'Ended') return 'badge-success';
            if (state.includes('Error') || state.includes('Fatal')) return 'badge-error';
            if (state === 'Scheduled' || state.includes('Joining')) return 'badge-info';
            return 'badge-warning';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Calendar Sync Health
        async function loadCalendarSync() {
            try {
                const data = await fetch('/dashboard/api/calendar-sync/').then(r => r.json());
                const calendars = data.calendars || [];

                document.getElementById('calendar-count').textContent = `${calendars.length} calendars`;

                const tbody = document.getElementById('calendar-sync-body');
                if (calendars.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5">No calendars configured</td></tr>';
                } else {
                    tbody.innerHTML = calendars.map(cal => {
                        const isError = cal.state === 'disconnected';
                        const rowClass = isError ? 'row-error' : '';

                        // Format last sync time
                        let lastSyncText = 'Never';
                        if (cal.sync_age_minutes !== null) {
                            if (cal.sync_age_minutes < 60) {
                                lastSyncText = `${cal.sync_age_minutes} min ago`;
                            } else if (cal.sync_age_minutes < 1440) {
                                lastSyncText = `${Math.floor(cal.sync_age_minutes / 60)}h ago`;
                            } else {
                                lastSyncText = `${Math.floor(cal.sync_age_minutes / 1440)} days ago`;
                            }
                        }

                        const statusBadge = isError
                            ? '<span class="badge badge-error">Disconnected</span>'
                            : '<span class="badge badge-success">Connected</span>';

                        const details = isError && cal.error
                            ? `<span class="error-text">${escapeHtml(cal.error)}</span>`
                            : '-';

                        return `
                            <tr class="${rowClass}">
                                <td><code>${cal.id}</code></td>
                                <td>${escapeHtml(cal.owner) || '-'}</td>
                                <td>${statusBadge}</td>
                                <td>${lastSyncText}</td>
                                <td>${details}</td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Failed to load calendar sync:', error);
            }
        }

        // Infrastructure Status
        let currentMode = 'docker';

        async function loadInfrastructure() {
            try {
                const data = await fetch('/dashboard/api/infrastructure/').then(r => r.json());
                const mode = data.mode || 'docker';
                currentMode = mode;

                // Update mode badge
                const modeBadge = document.getElementById('infra-mode-badge');
                modeBadge.textContent = mode === 'kubernetes' ? 'Kubernetes' : 'Docker';
                modeBadge.className = `badge ${mode === 'kubernetes' ? 'badge-info' : 'badge-secondary'}`;

                // Update log source options based on mode
                updateLogSourceOptions(mode);

                // Toggle sections based on mode
                const dockerSection = document.getElementById('docker-section');
                const k8sSection = document.getElementById('k8s-section');
                const k8sLookupSection = document.getElementById('k8s-lookup-section');

                if (mode === 'kubernetes') {
                    dockerSection.classList.add('hidden');
                    k8sSection.classList.add('visible');
                    k8sLookupSection.classList.add('visible');

                    // Update K8s stats
                    updateK8sStats(data.kubernetes);

                    // Load K8s alerts and pods
                    loadK8sAlerts();
                    loadK8sPods();
                } else {
                    dockerSection.classList.remove('hidden');
                    k8sSection.classList.remove('visible');
                    k8sLookupSection.classList.remove('visible');

                    // Container status
                    const containersRow = document.getElementById('containers-row');
                    const containers = data.containers || [];

                    if (containers.length === 0) {
                        containersRow.innerHTML = '<div class="stat-card"><div class="loading">No containers found</div></div>';
                    } else {
                        containersRow.innerHTML = containers.map(c => {
                            const isRunning = c.status === 'running';
                            const dotClass = isRunning ? 'status-green' : 'status-red';
                            const uptime = c.uptime || (isRunning ? 'Unknown' : 'Stopped');

                            return `
                                <div class="stat-card">
                                    <div class="value"><span class="status-dot ${dotClass}"></span></div>
                                    <div class="label">${escapeHtml(c.name)}</div>
                                    <div class="sublabel">${isRunning ? 'Up ' : ''}${uptime}</div>
                                </div>
                            `;
                        }).join('');
                    }
                }

                // Celery status (shown in both modes)
                const celery = data.celery || {};
                document.getElementById('celery-workers').textContent = celery.workers ?? '--';
                document.getElementById('celery-active').textContent = celery.active_tasks ?? '--';
                document.getElementById('celery-pending').textContent = celery.pending_tasks ?? '--';
                document.getElementById('celery-failed').textContent = celery.failed_recent ?? '--';

            } catch (error) {
                console.error('Failed to load infrastructure:', error);
            }
        }

        function updateK8sStats(k8s) {
            if (!k8s) return;

            // API health
            const apiStat = document.getElementById('k8s-api-stat');
            const apiStatus = document.getElementById('k8s-api-status');
            if (k8s.api_healthy) {
                apiStatus.textContent = '✓';
                apiStat.className = 'k8s-stat healthy';
            } else {
                apiStatus.textContent = '✗';
                apiStat.className = 'k8s-stat error';
            }

            // API latency
            document.getElementById('k8s-api-latency').textContent =
                k8s.api_latency_ms ? `${k8s.api_latency_ms}ms` : '--';

            // Pod counts from namespaces
            let totalRunning = 0, totalPending = 0, totalFailed = 0;
            for (const ns of (k8s.namespaces || [])) {
                if (ns.pods) {
                    totalRunning += ns.pods.running || 0;
                    totalPending += ns.pods.pending || 0;
                    totalFailed += ns.pods.failed || 0;
                }
            }

            document.getElementById('k8s-pods-running').textContent = totalRunning;
            document.getElementById('k8s-pods-pending').textContent = totalPending;
            document.getElementById('k8s-pods-failed').textContent = totalFailed;

            // Color code pending/failed
            const pendingStat = document.getElementById('k8s-pods-pending').parentElement;
            pendingStat.className = `k8s-stat ${totalPending > 0 ? 'warning' : ''}`;

            const failedStat = document.getElementById('k8s-pods-failed').parentElement;
            failedStat.className = `k8s-stat ${totalFailed > 0 ? 'error' : ''}`;

            // Nodes
            const nodes = k8s.nodes || {};
            document.getElementById('k8s-nodes-ready').textContent = `${nodes.ready || 0}/${nodes.total || 0}`;

            const nodesStat = document.getElementById('k8s-nodes-ready').parentElement;
            nodesStat.className = `k8s-stat ${nodes.not_ready > 0 ? 'error' : 'healthy'}`;

            // Resource bars
            const resources = k8s.resource_usage;
            if (resources) {
                // CPU
                const cpuPct = resources.cpu_allocatable_millicores > 0
                    ? (resources.cpu_requested_millicores / resources.cpu_allocatable_millicores) * 100
                    : 0;
                document.getElementById('k8s-cpu-pct').textContent = `${cpuPct.toFixed(1)}%`;
                const cpuBar = document.getElementById('k8s-cpu-bar');
                cpuBar.style.width = `${Math.min(cpuPct, 100)}%`;
                cpuBar.className = `resource-bar-fill ${cpuPct > 85 ? 'high' : cpuPct > 60 ? 'medium' : 'low'}`;

                // Memory
                const memPct = resources.memory_allocatable_bytes > 0
                    ? (resources.memory_requested_bytes / resources.memory_allocatable_bytes) * 100
                    : 0;
                document.getElementById('k8s-mem-pct').textContent = `${memPct.toFixed(1)}%`;
                const memBar = document.getElementById('k8s-mem-bar');
                memBar.style.width = `${Math.min(memPct, 100)}%`;
                memBar.className = `resource-bar-fill ${memPct > 85 ? 'high' : memPct > 60 ? 'medium' : 'low'}`;
            }
        }

        async function loadK8sAlerts() {
            try {
                const data = await fetch('/dashboard/api/k8s/alerts/').then(r => r.json());
                const alerts = data.alerts || [];
                const summary = data.summary || { critical: 0, warning: 0 };

                const banner = document.getElementById('k8s-alerts-banner');
                const alertCount = document.getElementById('k8s-alert-count');
                const alertDetail = document.getElementById('k8s-alert-detail');

                const total = summary.critical + summary.warning;
                if (total === 0) {
                    banner.style.display = 'flex';
                    banner.className = 'alert-banner healthy';
                    alertCount.textContent = 'No alerts';
                    alertDetail.textContent = 'Cluster is healthy';
                } else {
                    banner.style.display = 'flex';
                    banner.className = `alert-banner ${summary.critical > 0 ? 'critical' : 'warning'}`;
                    alertCount.textContent = `${total} alert${total !== 1 ? 's' : ''}`;

                    // Show first few alert messages
                    const details = alerts.slice(0, 3).map(a => a.message).join('; ');
                    alertDetail.textContent = details.length > 100 ? details.substring(0, 100) + '...' : details;
                }

            } catch (error) {
                console.error('Failed to load K8s alerts:', error);
            }
        }

        async function loadK8sPods() {
            try {
                const data = await fetch('/dashboard/api/k8s/pods/').then(r => r.json());
                const pods = data.pods || [];
                const issues = data.summary?.by_issue || {};

                const issuesContainer = document.getElementById('k8s-issues-container');
                const issuesBody = document.getElementById('k8s-issues-body');

                // Find pods with issues
                const problemPods = pods.filter(pod => {
                    // Check for restart count > 3
                    if (pod.container_statuses?.some(cs => cs.restart_count > 3)) return true;
                    // Check for waiting state with problem reason
                    if (pod.container_statuses?.some(cs =>
                        cs.state === 'waiting' && ['CrashLoopBackOff', 'ImagePullBackOff', 'ErrImagePull'].includes(cs.reason)
                    )) return true;
                    // Check for OOMKilled
                    if (pod.container_statuses?.some(cs => cs.reason === 'OOMKilled')) return true;
                    // Check for long pending
                    if (pod.phase === 'Pending' && pod.age_seconds > 300) return true;
                    return false;
                });

                if (problemPods.length === 0) {
                    issuesContainer.style.display = 'none';
                } else {
                    issuesContainer.style.display = 'block';
                    issuesBody.innerHTML = problemPods.slice(0, 10).map(pod => {
                        // Determine issue type
                        let issue = 'Unknown';
                        let issueClass = '';

                        for (const cs of (pod.container_statuses || [])) {
                            if (cs.restart_count > 3 || cs.reason === 'CrashLoopBackOff') {
                                issue = `CrashLoop (${cs.restart_count} restarts)`;
                                issueClass = 'issue-crashloop';
                                break;
                            }
                            if (['ImagePullBackOff', 'ErrImagePull'].includes(cs.reason)) {
                                issue = 'ImagePullError';
                                issueClass = 'issue-imagepull';
                                break;
                            }
                            if (cs.reason === 'OOMKilled') {
                                issue = 'OOMKilled';
                                issueClass = 'issue-oom';
                                break;
                            }
                        }

                        if (pod.phase === 'Pending' && pod.age_seconds > 300) {
                            issue = `Pending ${Math.floor(pod.age_seconds / 60)}m`;
                            issueClass = 'issue-pending';
                        }

                        const ageStr = pod.age_seconds
                            ? pod.age_seconds < 60 ? `${pod.age_seconds}s`
                            : pod.age_seconds < 3600 ? `${Math.floor(pod.age_seconds / 60)}m`
                            : `${Math.floor(pod.age_seconds / 3600)}h`
                            : '--';

                        return `
                            <tr>
                                <td><code>${escapeHtml(pod.name.substring(0, 30))}${pod.name.length > 30 ? '...' : ''}</code></td>
                                <td>${escapeHtml(pod.namespace)}</td>
                                <td><span class="issue-reason ${issueClass}">${escapeHtml(issue)}</span></td>
                                <td>${escapeHtml(pod.node) || '-'}</td>
                                <td>${ageStr}</td>
                            </tr>
                        `;
                    }).join('');
                }

            } catch (error) {
                console.error('Failed to load K8s pods:', error);
            }
        }

        async function doK8sLookup() {
            const input = document.getElementById('k8s-lookup-input').value.trim();
            if (!input) return;

            const resultDiv = document.getElementById('k8s-lookup-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading">Searching...</div>';

            try {
                const param = input.startsWith('bot_') ? 'bot_id' : 'pod_name';
                const data = await fetch(`/dashboard/api/k8s/bot-lookup/?${param}=${encodeURIComponent(input)}`).then(r => r.json());

                if (!data.found) {
                    resultDiv.innerHTML = '<div class="lookup-result"><p>No results found for: ' + escapeHtml(input) + '</p></div>';
                    return;
                }

                let html = '<div class="lookup-result">';

                // Bot info
                if (data.bot) {
                    html += '<h4>Bot Record</h4>';
                    html += `
                        <div class="detail-row"><span class="detail-label">Object ID:</span><span class="detail-value"><code>${escapeHtml(data.bot.object_id)}</code></span></div>
                        <div class="detail-row"><span class="detail-label">State:</span><span class="detail-value"><span class="badge ${getBadgeClass(data.bot.state)}">${escapeHtml(data.bot.state)}</span></span></div>
                        <div class="detail-row"><span class="detail-label">Meeting URL:</span><span class="detail-value">${escapeHtml(data.bot.meeting_url) || '-'}</span></div>
                        <div class="detail-row"><span class="detail-label">Last Heartbeat:</span><span class="detail-value">${data.bot.heartbeat_age_seconds !== null ? data.bot.heartbeat_age_seconds + 's ago' : 'Never'}</span></div>
                        <div class="detail-row"><span class="detail-label">Join At:</span><span class="detail-value">${data.bot.join_at ? new Date(data.bot.join_at).toLocaleString() : '-'}</span></div>
                    `;

                    if (data.events && data.events.length > 0) {
                        html += '<h4 style="margin-top: 12px;">Recent Bot Events</h4>';
                        html += '<div class="events-list">';
                        for (const e of data.events) {
                            html += `<div class="event-item">${new Date(e.timestamp).toLocaleTimeString()} - ${escapeHtml(e.type)}</div>`;
                        }
                        html += '</div>';
                    }
                }

                // Pod info
                if (data.pod) {
                    html += '<h4 style="margin-top: 16px;">Kubernetes Pod</h4>';
                    html += `
                        <div class="detail-row"><span class="detail-label">Pod Name:</span><span class="detail-value"><code>${escapeHtml(data.pod.name)}</code></span></div>
                        <div class="detail-row"><span class="detail-label">Namespace:</span><span class="detail-value">${escapeHtml(data.pod.namespace)}</span></div>
                        <div class="detail-row"><span class="detail-label">Phase:</span><span class="detail-value"><span class="badge ${data.pod.phase === 'Running' ? 'badge-success' : 'badge-warning'}">${escapeHtml(data.pod.phase)}</span></span></div>
                        <div class="detail-row"><span class="detail-label">Node:</span><span class="detail-value">${escapeHtml(data.pod.node) || '-'}</span></div>
                        <div class="detail-row"><span class="detail-label">Created:</span><span class="detail-value">${data.pod.created ? new Date(data.pod.created).toLocaleString() : '-'}</span></div>
                    `;

                    if (data.pod.events && data.pod.events.length > 0) {
                        html += '<h4 style="margin-top: 12px;">Recent K8s Events</h4>';
                        html += '<div class="events-list">';
                        for (const e of data.pod.events) {
                            const eventClass = e.type === 'Warning' ? 'badge-warning' : 'badge-info';
                            html += `<div class="event-item"><span class="badge ${eventClass}">${e.type}</span> ${escapeHtml(e.reason)}: ${escapeHtml(e.message)}</div>`;
                        }
                        html += '</div>';
                    }
                }

                if (data.pod_error) {
                    html += `<p style="color: #dc3545; margin-top: 12px;">Pod lookup error: ${escapeHtml(data.pod_error)}</p>`;
                }

                html += '</div>';
                resultDiv.innerHTML = html;

            } catch (error) {
                console.error('Failed to lookup bot/pod:', error);
                resultDiv.innerHTML = '<div class="lookup-result"><p style="color: #dc3545;">Lookup failed: ' + escapeHtml(error.message) + '</p></div>';
            }
        }

        // Allow enter key in lookup input
        document.getElementById('k8s-lookup-input')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') doK8sLookup();
        });

        // Live Logs Stream
        let logEventSource = null;
        let logPaused = false;
        let logLineCount = 0;
        let autoScroll = true;
        const MAX_LOG_LINES = 500;

        function updateLogSourceOptions(mode) {
            const logSource = document.getElementById('log-source');
            const currentValue = logSource.value;

            if (mode === 'kubernetes') {
                logSource.innerHTML = `
                    <option value="scheduler">scheduler (k8s)</option>
                    <option value="app">api (k8s)</option>
                `;
                // Set to scheduler if worker was selected (worker doesn't exist in k8s)
                if (currentValue === 'worker') {
                    logSource.value = 'scheduler';
                }
            } else {
                logSource.innerHTML = `
                    <option value="worker">worker</option>
                    <option value="scheduler">scheduler</option>
                    <option value="app">app</option>
                `;
            }
        }

        function initLogStream() {
            const source = document.getElementById('log-source').value;
            const level = document.getElementById('log-level').value;

            // Close existing connection
            if (logEventSource) {
                logEventSource.close();
            }

            const logContainer = document.getElementById('log-container');
            logContainer.innerHTML = '';
            logLineCount = 0;
            updateLogStatus('Connecting...');

            logEventSource = new EventSource(`/dashboard/api/logs/stream?source=${source}&level=${level}`);

            logEventSource.onopen = () => {
                updateLogStatus('Connected - Auto-scrolling');
            };

            logEventSource.onmessage = (event) => {
                if (logPaused) return;

                try {
                    const data = JSON.parse(event.data);

                    if (data.error) {
                        addLogLine('--:--:--', 'ERROR', data.error);
                        return;
                    }

                    addLogLine(data.time || '--:--:--', data.level || 'INFO', data.message || '');
                } catch (e) {
                    // Raw text log line
                    addLogLine('--:--:--', 'INFO', event.data);
                }
            };

            logEventSource.onerror = () => {
                updateLogStatus('Disconnected - Reconnecting...');
            };
        }

        function addLogLine(time, level, message) {
            const logContainer = document.getElementById('log-container');

            // Remove oldest lines if at max
            while (logContainer.children.length >= MAX_LOG_LINES) {
                logContainer.removeChild(logContainer.firstChild);
            }

            const levelClass = level === 'ERROR' || level === 'CRITICAL' ? 'log-error'
                             : level === 'WARNING' ? 'log-warning'
                             : 'log-info';

            const badgeClass = level === 'ERROR' || level === 'CRITICAL' ? 'badge-error'
                             : level === 'WARNING' ? 'badge-warning'
                             : 'badge-info';

            const line = document.createElement('div');
            line.className = `log-line ${levelClass}`;
            line.innerHTML = `
                <span class="log-time">${escapeHtml(time)}</span>
                <span class="badge ${badgeClass}">${level}</span>
                <span class="log-msg">${escapeHtml(message)}</span>
            `;

            logContainer.appendChild(line);
            logLineCount++;
            document.getElementById('log-count').textContent = `${logLineCount} lines`;

            // Auto-scroll if enabled
            if (autoScroll) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        function updateLogStatus(status) {
            document.getElementById('log-status').textContent = status;
        }

        // Log controls
        document.getElementById('log-pause').addEventListener('click', function() {
            logPaused = !logPaused;
            this.textContent = logPaused ? 'Resume' : 'Pause';
            updateLogStatus(logPaused ? 'Paused' : 'Connected - Auto-scrolling');
        });

        document.getElementById('log-clear').addEventListener('click', function() {
            document.getElementById('log-container').innerHTML = '';
            logLineCount = 0;
            document.getElementById('log-count').textContent = '0 lines';
        });

        document.getElementById('log-source').addEventListener('change', initLogStream);
        document.getElementById('log-level').addEventListener('change', initLogStream);

        // Detect manual scroll to disable auto-scroll
        document.getElementById('log-container').addEventListener('scroll', function() {
            const isAtBottom = this.scrollHeight - this.scrollTop <= this.clientHeight + 50;
            autoScroll = isAtBottom;
            if (!logPaused) {
                updateLogStatus(autoScroll ? 'Connected - Auto-scrolling' : 'Connected - Scroll paused');
            }
        });

        // Initial load
        loadData();
        initLogStream();

        // Auto-refresh every 30 seconds (except logs which stream continuously)
        setInterval(loadData, 30000);
    </script>
</body>
</html>
